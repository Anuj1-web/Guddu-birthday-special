<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Birthday City â€“ Upgraded Demo</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#0f1218}
  #overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#0009}
  #btn{font:600 15px system-ui;padding:12px 16px;border:0;border-radius:12px;cursor:pointer}
  #hud{position:fixed;left:50%;top:10px;transform:translateX(-50%);
       color:#fff;background:#0008;border-radius:10px;padding:6px 10px;font:600 12px system-ui}
  #msg{position:fixed;left:50%;top:50px;transform:translateX(-50%);
       color:#fff;background:#000b;border-radius:10px;padding:10px 14px;font:700 14px system-ui;display:none}
  #cross{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);color:#fff;opacity:.6;font:700 22px monospace}
</style>
</head>
<body>
<div id="overlay"><button id="btn">Click to enter â€¢ Mouse-look + WASD â€¢ Space jump</button></div>
<div id="hud">Controls: click to lock â€¢ WASD move â€¢ Space jump â€¢ Aim crosshair + click to collect gifts</div>
<div id="msg"></div>
<div id="cross">+</div>

<script src="three.min.js"></script>

<!-- PointerLockControls (non-module, with lock/unlock events) -->
<script>
THREE.PointerLockControls=function(camera,dom){
  const S=this; this.domElement=dom||document.body; this.isLocked=false;
  const E={change:{type:'change'},lock:{type:'lock'},unlock:{type:'unlock'}};
  const euler=new THREE.Euler(0,0,0,'YXZ'), PI_2=Math.PI/2;
  function onMove(ev){
    if(!S.isLocked) return;
    const mx=ev.movementX||0, my=ev.movementY||0;
    euler.setFromQuaternion(camera.quaternion);
    euler.y-=mx*0.002; euler.x-=my*0.002; euler.x=Math.max(-PI_2,Math.min(PI_2,euler.x));
    camera.quaternion.setFromEuler(euler); S.dispatchEvent(E.change);
  }
  function onPLC(){ S.isLocked=(document.pointerLockElement===S.domElement); S.dispatchEvent(S.isLocked?E.lock:E.unlock); }
  function onPLE(){ console.error('Pointer Lock error'); }
  this.lock=()=>this.domElement.requestPointerLock();
  this.unlock=()=>document.exitPointerLock();
  this.connect=()=>{
    document.addEventListener('mousemove',onMove); document.addEventListener('pointerlockchange',onPLC);
    document.addEventListener('pointerlockerror',onPLE);
  };
  this.disconnect=()=>{
    document.removeEventListener('mousemove',onMove); document.removeEventListener('pointerlockchange',onPLC);
    document.removeEventListener('pointerlockerror',onPLE);
  };
  this.dispose=()=>this.disconnect(); this.connect();
};
THREE.PointerLockControls.prototype=Object.create(THREE.EventDispatcher.prototype);
THREE.PointerLockControls.prototype.constructor=THREE.PointerLockControls;
</script>

<script>
let scene, camera, renderer, controls, raycaster, gifts=[];
let moveF=false, moveB=false, moveL=false, moveR=false, canJump=false, day=true;
const velocity=new THREE.Vector3(), dir=new THREE.Vector3();
const GRAV=30;
const clock=new THREE.Clock();

init(); animate();

function init(){
  scene=new THREE.Scene(); setSky(true);

  camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,1000);
  camera.position.set(0,1.1,6);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(devicePixelRatio);
  renderer.setSize(innerWidth,innerHeight);
  renderer.shadowMap.enabled=true;
  document.body.appendChild(renderer.domElement);

  raycaster=new THREE.Raycaster();

  // ground
  const gTex=makeRoadTex();
  gTex.anisotropy=renderer.capabilities.getMaxAnisotropy();
  const ground=new THREE.Mesh(new THREE.PlaneGeometry(200,200),
    new THREE.MeshStandardMaterial({map:gTex, roughness:.95}));
  ground.rotation.x=-Math.PI/2; ground.receiveShadow=true; scene.add(ground);

  // lights
  const hemi=new THREE.HemisphereLight(0xbfd9ff,0x23262b,.9); scene.add(hemi);
  const sun=new THREE.DirectionalLight(0xffffff,.9); sun.position.set(40,80,20);
  sun.castShadow=true; sun.name='SUN'; scene.add(sun);

  // one realistic building (higher res facade)
  const facade=makeFacadeTex();
  facade.anisotropy=renderer.capabilities.getMaxAnisotropy();
  const bMat=new THREE.MeshStandardMaterial({map:facade, roughness:.6, metalness:.1});
  const building=new THREE.Mesh(new THREE.BoxGeometry(12,25,12), bMat);
  building.position.set(0,12.5,-18); building.castShadow=true; building.receiveShadow=true; scene.add(building);

  // hoarding
  addHoarding(new THREE.Vector3(0,15,-12),
    "https://dl.dropboxusercontent.com/scl/fi/cov38hf9qc6cy4e4c4io9/IMG-20250815-WA0000.jpg?rlkey=8b4oa8vuje8464x6fucpv5xto&st=odlchui1&dl=1",
    8,5,new THREE.Vector3(0,15,30));

  // gift with texture
  const gift=createGift(new THREE.Vector3(3,1,0),"Happy Birthday Guddu! ðŸŽ‚âœ¨");
  gifts.push(gift);

  // controls
  controls=new THREE.PointerLockControls(camera,document.body);
  document.getElementById('btn').onclick=()=>{ controls.lock(); document.getElementById('overlay').style.display='none'; };
  controls.addEventListener('unlock',()=>{ document.getElementById('overlay').style.display='flex'; });

  addEventListener('keydown',onKeyDown);
  addEventListener('keyup',onKeyUp);
  addEventListener('click',onMouseClick);
  addEventListener('resize',()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
}

function animate(){
  requestAnimationFrame(animate);
  const dt=Math.min(0.05,clock.getDelta());

  dir.set(0,0,0);
  if(moveF) dir.z-=1; if(moveB) dir.z+=1; if(moveL) dir.x-=1; if(moveR) dir.x+=1;
  if(dir.lengthSq()>0) dir.normalize();

  const speed=10*dt;
  const yaw=new THREE.Quaternion().setFromEuler(new THREE.Euler(0,camera.rotation.y,0));
  const step=dir.clone().applyQuaternion(yaw).multiplyScalar(speed);
  camera.position.add(new THREE.Vector3(step.x,0,step.z));

  velocity.y -= GRAV*dt;
  camera.position.y += velocity.y*dt;
  if(camera.position.y<1.1){ camera.position.y=1.1; velocity.y=0; canJump=true; }

  renderer.render(scene,camera);
}

/* === INTERACTIONS === */
function onMouseClick(){
  raycaster.setFromCamera(new THREE.Vector2(0,0),camera); // center crosshair
  const intersects=raycaster.intersectObjects(gifts.map(g=>g.mesh),false);
  if(intersects.length>0){
    const gift=gifts.find(g=>g.mesh===intersects[0].object);
    if(gift && !gift.collected){
      gift.collected=true; scene.remove(gift.mesh);
      sparkle(gift.mesh.position); chime(); showMsg(gift.msg);
    }
  }
}
function onKeyDown(e){
  switch(e.code){
    case'KeyW':case'ArrowUp':moveF=true;break;
    case'KeyS':case'ArrowDown':moveB=true;break;
    case'KeyA':case'ArrowLeft':moveL=true;break;
    case'KeyD':case'ArrowRight':moveR=true;break;
    case'Space':if(canJump){velocity.y=10;canJump=false;}break;
    case'KeyN':setSky(!day);break;
  }
}
function onKeyUp(e){
  switch(e.code){
    case'KeyW':case'ArrowUp':moveF=false;break;
    case'KeyS':case'ArrowDown':moveB=false;break;
    case'KeyA':case'ArrowLeft':moveL=false;break;
    case'KeyD':case'ArrowRight':moveR=false;break;
  }
}

/* === HELPERS (same as before but sharper) === */
function setSky(isDay){ day=isDay; const col=isDay?0x87c9ff:0x0b0e15;
  scene.background=new THREE.Color(col); if(scene.fog) scene.fog.color.set(col);
  scene.traverse(o=>{ if(o.isDirectionalLight&&o.name==='SUN') o.intensity=isDay?.9:.15; });
}
function makeRoadTex(){ const s=1024,c=document.createElement('canvas');c.width=c.height=s;const x=c.getContext('2d');
  x.fillStyle='#3b3f46';x.fillRect(0,0,s,s);x.fillStyle='#343842';for(let i=0;i<s;i+=16){x.fillRect(0,i,s,2);x.fillRect(i,0,2,s);}
  const t=new THREE.CanvasTexture(c);t.wrapS=t.wrapT=THREE.RepeatWrapping;t.repeat.set(20,20);return t;}
function makeFacadeTex(){ const w=256,h=512,c=document.createElement('canvas');c.width=w;c.height=h;const ctx=c.getContext('2d');
  ctx.fillStyle='#2f3549';ctx.fillRect(0,0,w,h);for(let y=8;y<h;y+=14){for(let x=8;x<w;x+=14){ctx.fillStyle=Math.random()<.25?'#ffe9b6':'#1a2235';ctx.fillRect(x,y,10,10);}}
  const t=new THREE.CanvasTexture(c);t.wrapS=t.wrapT=THREE.RepeatWrapping;t.repeat.set(1,4);return t;}
function addHoarding(pos,imgUrl,w,h,lookAtVec){ const loader=new THREE.TextureLoader();loader.load(imgUrl,(tex)=>{tex.anisotropy=renderer.capabilities.getMaxAnisotropy();
  const frame=new THREE.Mesh(new THREE.PlaneGeometry(w+0.5,h+0.5),new THREE.MeshBasicMaterial({color:0x0b0e14}));
  const board=new THREE.Mesh(new THREE.PlaneGeometry(w,h),new THREE.MeshBasicMaterial({map:tex}));
  frame.position.copy(pos);board.position.copy(pos);board.lookAt(lookAtVec);frame.lookAt(lookAtVec);frame.position.z-=0.01;scene.add(frame);scene.add(board);});}
function createGift(pos,msg){ const tex=new THREE.TextureLoader().load("https://i.imgur.com/E5oVZbA.png");
  const mat=new THREE.MeshStandardMaterial({map:tex,roughness:.5}); const mesh=new THREE.Mesh(new THREE.BoxGeometry(1.4,1.4,1.4),mat);
  mesh.position.copy(pos); mesh.castShadow=true; scene.add(mesh); return {mesh,msg,collected:false}; }
function sparkle(origin){ const geom=new THREE.SphereGeometry(0.05,6,6),group=new THREE.Group();scene.add(group);
  for(let i=0;i<90;i++){const m=new THREE.MeshBasicMaterial({color:0xffe0ff,transparent:true,opacity:1});
    const p=new THREE.Mesh(geom,m);p.position.copy(origin);p.userData.v=new THREE.Vector3((Math.random()-0.5)*3,Math.random()*3,(Math.random()-0.5)*3);
    group.add(p);}const t0=performance.now();(function tick(){const t=(performance.now()-t0)/1000;
    for(const p of group.children){p.position.addScaledVector(p.userData.v,0.016);p.userData.v.y-=3*0.016;p.material.opacity=Math.max(0,1-t);}if(t<1.0)requestAnimationFrame(tick);else scene.remove(group);})(); }
function chime(){const AC=window.AudioContext||window.webkitAudioContext;if(!AC)return;const ac=new AC(),o=ac.createOscillator(),g=ac.createGain();
  o.type='triangle';o.frequency.value=880;g.gain.setValueAtTime(0.0001,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.25,ac.currentTime+0.03);
  g.gain.exponentialRampToValueAtTime(0.0001,ac.currentTime+0.5);o.connect(g).connect(ac.destination);o.start();o.stop(ac.currentTime+0.55);}
function showMsg(t){const el=document.getElementById('msg');el.textContent=t;el.style.display='block';clearTimeout(showMsg.t);showMsg.t=setTimeout(()=>el.style.display='none',3000);}
</script>
</body>
</html>
