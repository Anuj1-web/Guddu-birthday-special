<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Realistic Birthday Garden</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: linear-gradient(#9fd3ff, #e9f9ff);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color: #18324d;
    overflow: hidden;
  }
  #app {
    position: fixed;
    inset: 0;
  }
  canvas { display: block; }

  /* top bar (desktop), hidden on narrow screens */
  .topbar {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    padding: 8px 12px;
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(6px);
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    z-index: 20;
  }
  .btn {
    border: 0;
    border-radius: 12px;
    padding: 8px 12px;
    cursor: pointer;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    background: #ffffff;
  }
  .btn:active { transform: translateY(1px); }
  .btn.toggle.on { background: #18324d; color: #fff; }

  /* Mobile three-dots floating menu */
  .fab-menu {
    position: fixed;
    right: 12px;
    top: 12px;
    z-index: 30;
  }
  .fab {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: rgba(24,50,77,0.9);
    color: #fff;
    font-size: 22px;
    line-height: 44px;
    text-align: center;
    box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    cursor: pointer;
  }
  .sheet {
    position: absolute;
    right: 0;
    top: 54px;
    min-width: 220px;
    background: rgba(255,255,255,0.95);
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    padding: 10px;
    display: none;
  }
  .sheet.open { display: block; }
  .sheet .row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 8px 6px;
    border-radius: 10px;
  }
  .sheet .row:hover { background: rgba(0,0,0,0.05); }
  .switch {
    appearance: none;
    width: 42px; height: 24px;
    border-radius: 999px;
    position: relative; outline: none;
    background: #c7d3e1; cursor: pointer;
  }
  .switch:checked { background: #18324d; }
  .switch::after {
    content: "";
    position: absolute; top: 3px; left: 3px;
    width: 18px; height: 18px; border-radius: 50%; background: #fff;
    transition: transform .2s ease;
  }
  .switch:checked::after { transform: translateX(18px); }

  /* Message overlay for gifts/flowers/candies/hoardings */
  .msg-overlay {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
  }
  .msg-overlay.open { display: flex; }
  .backdrop {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(3px);
  }
  .card {
    position: relative;
    max-width: min(90vw, 640px);
    width: 100%;
    background: #ffffff;
    border-radius: 18px;
    box-shadow: 0 16px 60px rgba(0,0,0,0.35);
    padding: 18px 18px 14px;
    text-align: center;
    z-index: 2;
  }
  .card .title {
    font-size: 20px; font-weight: 800; letter-spacing: .2px;
    margin-bottom: 8px;
  }
  .card .text { font-size: 16px; margin: 6px 0 12px; line-height: 1.5; }
  .card .thumb {
    max-height: 60vh; max-width: 100%;
    border-radius: 12px;
    object-fit: contain;
    background: #f6f7f9;
  }
  .close-x {
    position: absolute; right: 10px; top: 8px;
    border: none; background: transparent; font-size: 22px; cursor: pointer;
  }

  /* Hoarding caption */
  .caption { font-size: 14px; opacity: 0.8; margin-top: 8px; }

  /* Hide topbar on small screens and show fab */
  @media (max-width: 880px) {
    .topbar { display: none; }
    .fab-menu { display: block; }
  }
  @media (min-width: 881px) {
    .fab-menu { display: none; }
  }
</style>
</head>
<body>
<div id="app"></div>

<!-- UI -->
<div class="topbar" id="topbar">
  <button class="btn toggle" id="btnDayNight">Day</button>
  <button class="btn toggle on" id="btnEffects">Effects</button>
  <button class="btn toggle on" id="btnBirds">Birds</button>
  <button class="btn toggle on" id="btnButterflies">Butterflies</button>
  <button class="btn toggle on" id="btnSounds">Sound</button>
  <button class="btn" id="btnCenter">Center</button>
</div>

<div class="fab-menu">
  <button class="fab" id="fab">⋮</button>
  <div class="sheet" id="sheet">
    <div class="row"><span>Night mode</span><input id="swDayNight" class="switch" type="checkbox"/></div>
    <div class="row"><span>Visual effects</span><input id="swEffects" class="switch" type="checkbox" checked/></div>
    <div class="row"><span>Birds</span><input id="swBirds" class="switch" type="checkbox" checked/></div>
    <div class="row"><span>Butterflies</span><input id="swButterflies" class="switch" type="checkbox" checked/></div>
    <div class="row"><span>Sound</span><input id="swSounds" class="switch" type="checkbox" checked/></div>
    <div class="row"><button id="btnCenterM" class="btn" style="width:100%;">Center Camera</button></div>
  </div>
</div>

<!-- Message overlay -->
<div class="msg-overlay" id="overlay">
  <div class="backdrop" id="overlayBg"></div>
  <div class="card">
    <button class="close-x" id="closeOverlay">×</button>
    <div class="title" id="ovTitle">Surprise</div>
    <img id="ovImg" class="thumb" alt=""/>
    <div class="text" id="ovText">You found something lovely in the garden.</div>
    <div class="caption" id="ovCaption"></div>
  </div>
</div>

<!-- Three.js non-module + OrbitControls non-module -->
<script src="three.min.js"></script>
<script src="OrbitControls.js"></script>

<script>
(function(){
  // ---------- Basic setup ----------
  const app = document.getElementById('app');
  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.8));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.outputEncoding = THREE.sRGBEncoding;
  app.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  scene.fog = new THREE.FogExp2(0xbfe7ff, 0.00055);

  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 20000);
  camera.position.set(0, 5.2, 12);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.06;
  controls.enablePan = false; // keep simple
  controls.minDistance = 4;
  controls.maxDistance = 40;
  controls.minPolarAngle = Math.PI * 0.1;
  controls.maxPolarAngle = Math.PI * 0.48;

  // ---------- Lights ----------
  const hemi = new THREE.HemisphereLight(0xbfe7ff, 0x9ec08a, 0.8);
  scene.add(hemi);
  const sun = new THREE.DirectionalLight(0xffffff, 0.75);
  sun.position.set(40, 80, 30);
  sun.castShadow = false;
  scene.add(sun);

  const nightGroup = new THREE.Group(); // stars + fireflies + lamp glows
  scene.add(nightGroup);
  nightGroup.visible = false;

  // ---------- Ground + path ----------
  const WORLD_LEN = 5200; // long but finite
  const PATH_Z0 = -WORLD_LEN/2;
  const PATH_Z1 =  WORLD_LEN/2;
  const pathWidth = 5.5;

  const groundGeo = new THREE.PlaneGeometry(200, WORLD_LEN, 200, 1200);
  groundGeo.rotateX(-Math.PI/2);

  // Gentle noise for bumps
  function fbm2(x, y) {
    return (Math.sin(x*0.08)+Math.sin(y*0.1))*0.5*0.2 + (Math.sin(x*0.4+y*0.35))*0.08;
  }
  const gPos = groundGeo.attributes.position;
  for (let i=0;i<gPos.count;i++){
    const x = gPos.getX(i);
    const z = gPos.getZ(i);
    const h = fbm2(x, z);
    gPos.setY(i, h);
  }
  gPos.needsUpdate = true;
  groundGeo.computeVertexNormals();

  // Vertex colors to make path and edges visible
  const colors = [];
  for (let i=0;i<gPos.count;i++){
    const x = gPos.getX(i);
    const z = gPos.getZ(i);
    const onPath = Math.abs(x) < (pathWidth*0.5);
    const t = Math.min(1, Math.abs(x)/(pathWidth*0.5));
    const grass = new THREE.Color().setHSL(0.32, 0.6, 0.45 + Math.random()*0.03);
    const dirt  = new THREE.Color().setHSL(0.09, 0.55, 0.42 + (Math.random()*0.02));
    const c = onPath ? dirt : grass;
    colors.push(c.r, c.g, c.b);
  }
  groundGeo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

  const groundMat = new THREE.MeshLambertMaterial({ vertexColors: true });
  const ground = new THREE.Mesh(groundGeo, groundMat);
  scene.add(ground);

  // ---------- Realistic grass (instanced blades with shader sway) ----------
  const GRASS_COUNT = 90000;
  const grassGeo = new THREE.PlaneGeometry(0.06, 0.8, 1, 3);
  grassGeo.translate(0, 0.4, 0);

  const grassMat = new THREE.ShaderMaterial({
    uniforms: {
      uTime: { value: 0 },
      cA: { value: new THREE.Color(0x285c2f) },
      cB: { value: new THREE.Color(0x74b86a) },
      uWind: { value: 0.4 }
    },
    vertexShader: [
      'uniform float uTime;',
      'uniform float uWind;',
      'varying float vY;',
      'void main(){',
      '  vY = position.y;',
      '  vec3 p = position.xyz;',
      '  float bend = sin( (position.y*3.0) + uTime*1.6 ) * 0.03 * uWind;',
      '  p.x += bend * (position.y);',
      '  gl_Position = projectionMatrix * modelViewMatrix * vec4(p, 1.0);',
      '}'
    ].join('\n'),
    fragmentShader: [
      'varying float vY;',
      'uniform vec3 cA; uniform vec3 cB;',
      'void main(){',
      '  float t = smoothstep(0.0, 0.7, vY);',
      '  vec3 col = mix(cA, cB, t);',
      '  gl_FragColor = vec4(col, 1.0);',
      '}'
    ].join('\n'),
    side: THREE.DoubleSide
  });

  const grass = new THREE.InstancedMesh(grassGeo, grassMat, GRASS_COUNT);
  grass.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
  scene.add(grass);

  const dummy = new THREE.Object3D();
  for (let i=0;i<GRASS_COUNT;i++){
    // distribute off the path for performance
    let x = (Math.random()-0.5)*200;
    if (Math.abs(x) < pathWidth*0.8) x = (x<0 ? -1 : 1) * (pathWidth*0.8 + Math.random()*40);
    const z = PATH_Z0 + Math.random()*WORLD_LEN;
    const y = fbm2(x, z);
    const rot = Math.random()*Math.PI*2;
    const s = 0.7 + Math.random()*0.6;
    dummy.position.set(x, y, z);
    dummy.rotation.set(-0.05+Math.random()*0.1, rot, 0);
    dummy.scale.setScalar(s);
    dummy.updateMatrix();
    grass.setMatrixAt(i, dummy.matrix);
  }
  grass.instanceMatrix.needsUpdate = true;

  // ---------- Trees (simple stylized) ----------
  function makeTree() {
    const g = new THREE.Group();
    const trunkGeo = new THREE.CylinderGeometry(0.15, 0.3, 3.6, 6);
    const trunkMat = new THREE.MeshStandardMaterial({ color: 0x7a5a44, roughness: 0.9, metalness: 0 });
    const trunk = new THREE.Mesh(trunkGeo, trunkMat);
    trunk.castShadow = false; trunk.receiveShadow = false;
    g.add(trunk);

    const crownGeo = new THREE.IcosahedronGeometry(1.6, 1);
    const crownMat = new THREE.MeshStandardMaterial({ color: 0x3f8f4f, roughness: 0.6, metalness: 0.0 });
    const crown = new THREE.Mesh(crownGeo, crownMat);
    crown.position.y = 2.4;
    g.add(crown);

    // flowers on the crown (tiny planes)
    const petals = new THREE.Group();
    for (let i=0;i<20;i++){
      const pG = new THREE.PlaneGeometry(0.12, 0.12);
      const pM = new THREE.MeshBasicMaterial({ color: 0xffc3d9, side: THREE.DoubleSide });
      const p = new THREE.Mesh(pG, pM);
      p.position.set((Math.random()-0.5)*2.5, 2.2 + Math.random()*0.8, (Math.random()-0.5)*2.5);
      p.rotation.y = Math.random()*Math.PI;
      petals.add(p);
    }
    g.add(petals);

    return g;
  }
  const treeGroup = new THREE.Group();
  scene.add(treeGroup);
  for (let i=0;i<80;i++){
    const t = makeTree();
    const xSide = Math.random()<0.5 ? -1 : 1;
    const x = xSide*(pathWidth*1.2 + 4 + Math.random()*60);
    const z = PATH_Z0 + Math.random()*WORLD_LEN;
    t.position.set(x, fbm2(x,z), z);
    t.scale.setScalar(0.9 + Math.random()*0.8);
    treeGroup.add(t);
  }

  // ---------- Lamps for night ----------
  const lampGroup = new THREE.Group();
  scene.add(lampGroup);
  function makeLamp(){
    const g = new THREE.Group();
    const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.06,2.4,8), new THREE.MeshStandardMaterial({ color: 0x404650, metalness: 0.4, roughness: 0.5 }));
    pole.position.y = 1.2;
    g.add(pole);
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.18, 10, 8), new THREE.MeshStandardMaterial({ color: 0xffe8b2, emissive: 0x000000 }));
    head.position.y = 2.4;
    g.add(head);
    const glow = new THREE.PointLight(0xffe8b2, 0, 6, 1.2);
    glow.position.y = 2.4;
    g.add(glow);
    g.userData.glow = glow;
    return g;
  }
  for (let i=0;i<34;i++){
    const l = makeLamp();
    const x = (i%2===0 ? -1:1)*(pathWidth*0.65 + 1.2);
    const z = PATH_Z0 + (i/(34-1))*WORLD_LEN;
    l.position.set(x, fbm2(x,z), z);
    lampGroup.add(l);
  }

  // ---------- Hoardings (user images) ----------
  const HOARDING_IMAGES = [
    // Converted to dl=1 for direct image response from Dropbox
    toDirect('https://www.dropbox.com/scl/fi/u98gnws5gdqjxqoln440b/IMG-20250815-WA0010.jpg?rlkey=snhn8qgohmv851usrxps09n9m&st=kqb90zz5&dl=0'),
    toDirect('https://www.dropbox.com/scl/fi/cov38hf9qc6cy4e4c4io9/IMG-20250815-WA0000.jpg?rlkey=8b4oa8vuje8464x6fucpv5xto&st=coa9io67&dl=0'),
    toDirect('https://www.dropbox.com/scl/fi/2mcpq9fuoqqdrfncxo17f/IMG-20250304-WA0006.jpg?rlkey=9giowulkgwin4l9q0pnphmmiq&st=4eg4lvbs&dl=0'),
    toDirect('https://www.dropbox.com/scl/fi/pnr4hg3cszl67aojrz5yb/IMG-20250815-WA0008.jpg?rlkey=tqlohjwragswplmwl9jgmim37&st=iu62z8rd&dl=0'),
    toDirect('https://www.dropbox.com/scl/fi/0a1ckwv332kos7s2koy3n/IMG-20250815-WA0003.jpg?rlkey=m4bcqn577zxvq69qt8gotci7y&st=xg32j4v0&dl=0'),
  ];
  function toDirect(url){
    // Dropbox: ensure ?raw=1 or dl=1 to get the image file, not an HTML landing page
    if (!url) return url;
    if (url.includes('dropbox.com')){
      if (url.includes('dl=')){
        return url.replace(/dl=\d/, 'dl=1');
      } else if (url.includes('?')) {
        return url + '&dl=1';
      } else {
        return url + '?dl=1';
      }
    }
    return url;
  }
  const hoardGroup = new THREE.Group();
  scene.add(hoardGroup);

  const texLoader = new THREE.TextureLoader();
  texLoader.crossOrigin = 'anonymous';

  function makeHoarding(imgUrl){
    const g = new THREE.Group();
    const frame = new THREE.Mesh(
      new THREE.BoxGeometry(5.6, 3.8, 0.12),
      new THREE.MeshStandardMaterial({ color: 0x2d3442, metalness: 0.3, roughness: 0.6 })
    );
    g.add(frame);

    const pic = new THREE.Mesh(
      new THREE.PlaneGeometry(5.1, 3.3),
      new THREE.MeshBasicMaterial({ color: 0xffffff })
    );
    pic.position.z = 0.07;
    g.add(pic);

    const url = imgUrl;
    texLoader.load(url, (tex)=>{
      tex.encoding = THREE.sRGBEncoding;
      tex.anisotropy = 8;
      pic.material.map = tex;
      pic.material.needsUpdate = true;
    }, undefined, (err)=>{
      console.warn('Failed to load hoarding image:', url, err);
      const ctx = document.createElement('canvas').getContext('2d');
      ctx.canvas.width = 256; ctx.canvas.height = 256;
      ctx.fillStyle = '#eee'; ctx.fillRect(0,0,256,256);
      ctx.fillStyle = '#888'; ctx.fillText('Image', 100, 128);
      const tex = new THREE.CanvasTexture(ctx.canvas);
      pic.material.map = tex; pic.material.needsUpdate = true;
    });

    g.userData.type = 'hoarding';
    g.userData.imgUrl = url;
    return g;
  }

  const HOARD_COUNT = 18;
  for (let i=0;i<HOARD_COUNT;i++){
    const url = HOARDING_IMAGES[i % HOARDING_IMAGES.length];
    const h = makeHoarding(url);
    const side = (i%2===0) ? -1 : 1;
    const x = side * (pathWidth*0.9 + 3.5);
    const z = PATH_Z0 + (i/(HOARD_COUNT))*WORLD_LEN + (Math.random()-0.5)*140;
    h.position.set(x, fbm2(x,z), z);
    h.rotation.y = side>0 ? -0.12 : 0.12;
    hoardGroup.add(h);
  }

  // ---------- Gifts / Flowers / Candies ----------
  const interactGroup = new THREE.Group();
  scene.add(interactGroup);

  function makeGift(){
    const g = new THREE.Group();
    const box = new THREE.Mesh(new THREE.BoxGeometry(0.9,0.9,0.9), new THREE.MeshStandardMaterial({ color: 0xff6aa0, roughness: 0.4 }));
    const lid = new THREE.Mesh(new THREE.BoxGeometry(0.92,0.2,0.92), new THREE.MeshStandardMaterial({ color: 0xffb3cc, roughness: 0.5 }));
    lid.position.y = 0.55;
    box.position.y = 0.45;
    const ribbon = new THREE.Mesh(new THREE.TorusGeometry(0.42, 0.05, 8, 24), new THREE.MeshStandardMaterial({ color: 0xffffff, metalness: 0.2 }));
    ribbon.rotation.x = Math.PI/2;
    ribbon.position.y = 0.55;
    g.add(box, lid, ribbon);
    g.userData.type = 'gift';
    return g;
  }
  function makeFlower(){
    const g = new THREE.Group();
    const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.9,6), new THREE.MeshStandardMaterial({ color: 0x3b9a50 }));
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.18, 10, 8), new THREE.MeshStandardMaterial({ color: 0xffd35b }));
    stem.position.y = 0.45;
    head.position.y = 0.95;
    g.add(stem, head);
    g.userData.type = 'flower';
    return g;
  }
  function makeCandy(){
    const g = new THREE.Group();
    const body = new THREE.Mesh(new THREE.CylinderGeometry(0.13, 0.13, 0.5, 16), new THREE.MeshStandardMaterial({ color: 0xa78bfa, metalness: 0.2, roughness: 0.2 }));
    body.rotation.z = Math.PI/2;
    const wrapL = new THREE.Mesh(new THREE.ConeGeometry(0.14, 0.14, 10), new THREE.MeshStandardMaterial({ color: 0xd6bcfa, metalness: 0.1 }));
    const wrapR = wrapL.clone();
    wrapL.position.x = -0.32; wrapR.position.x = 0.32; wrapR.rotation.z = Math.PI;
    g.add(body, wrapL, wrapR);
    g.userData.type = 'candy';
    return g;
  }

  const ITEMS = 200;
  for (let i=0;i<ITEMS;i++){
    const t = Math.random();
    const maker = t<0.34 ? makeGift : (t<0.67 ? makeFlower : makeCandy);
    const m = maker();
    const x = (Math.random()-0.5)*pathWidth*0.75; // on path
    const z = PATH_Z0 + Math.random()*WORLD_LEN;
    const y = fbm2(x,z);
    m.position.set(x, y, z);
    m.rotation.y = Math.random()*Math.PI*2;
    interactGroup.add(m);
  }

  // ---------- Butterflies ----------
  const butterflies = [];
  function makeButterfly(){
    const g = new THREE.Group();
    const wingGeo = new THREE.PlaneGeometry(0.6, 0.5);
    const mat = new THREE.MeshBasicMaterial({ color: 0xff7ab6, side: THREE.DoubleSide });
    const wL = new THREE.Mesh(wingGeo, mat);
    const wR = new THREE.Mesh(wingGeo, mat);
    wL.position.x = -0.3; wR.position.x = 0.3;
    g.add(wL, wR);
    g.userData.wings = [wL, wR];
    g.userData.phase = Math.random()*Math.PI*2;
    return g;
  }
  for (let i=0;i<30;i++){
    const b = makeButterfly();
    const x = (Math.random()-0.5)*60;
    const z = PATH_Z0 + Math.random()*WORLD_LEN;
    const y = 1.0 + Math.random()*2.5 + fbm2(x,z);
    b.position.set(x,y,z);
    butterflies.push(b);
    scene.add(b);
  }

  // ---------- Birds ----------
  const birds = [];
  function makeBird(){
    const g = new THREE.Group();
    const body = new THREE.Mesh(new THREE.SphereGeometry(0.25, 10, 8), new THREE.MeshStandardMaterial({ color: 0x4b6cb7, metalness: 0.1, roughness: 0.6 }));
    const wing = new THREE.Mesh(new THREE.PlaneGeometry(0.5, 0.18), new THREE.MeshStandardMaterial({ color: 0x87a8ff, side: THREE.DoubleSide }));
    const wing2 = wing.clone();
    wing.position.set(-0.25, 0.05, 0); wing2.position.set(0.25, 0.05, 0);
    g.add(body, wing, wing2);
    g.userData.wings = [wing, wing2];
    g.userData.phase = Math.random()*Math.PI*2;
    return g;
  }
  for (let i=0;i<14;i++){
    const b = makeBird();
    const x = -30 + Math.random()*60;
    const z = PATH_Z0 + Math.random()*WORLD_LEN;
    const y = 4 + Math.random()*6 + fbm2(x,z);
    b.position.set(x,y,z);
    birds.push(b);
    scene.add(b);
  }

  // ---------- Particles (sparkles/hearts when interact or bird flyover) ----------
  const particleGeo = new THREE.BufferGeometry();
  const P_MAX = 2000;
  const pPositions = new Float32Array(P_MAX*3);
  const pLife = new Float32Array(P_MAX);
  particleGeo.setAttribute('position', new THREE.BufferAttribute(pPositions, 3));
  const particleMat = new THREE.PointsMaterial({ size: 0.06, color: 0xff77d6, transparent: true, opacity: 0.9 });
  const particles = new THREE.Points(particleGeo, particleMat);
  scene.add(particles);
  let pCursor = 0;
  function spawnParticles(pos, n=30, type='spark'){
    for(let i=0;i<n;i++){
      const idx = pCursor % P_MAX;
      pPositions[idx*3+0] = pos.x + (Math.random()-0.5)*0.6;
      pPositions[idx*3+1] = pos.y + (Math.random())*0.8;
      pPositions[idx*3+2] = pos.z + (Math.random()-0.5)*0.6;
      pLife[idx] = type==='heart' ? 1.4 : 0.8;
      pCursor++;
    }
    particleGeo.attributes.position.needsUpdate = true;
  }

  // ---------- Sound (simple synth chirp) ----------
  let audioCtx = null;
  function ensureAudio(){
    if (!audioCtx){
      try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}
    }
  }
  function chirp(){
    if (!soundOn || !audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type = 'sine';
    const t = audioCtx.currentTime;
    o.frequency.setValueAtTime(800, t);
    o.frequency.exponentialRampToValueAtTime(1600, t+0.08);
    g.gain.value = 0.0008;
    g.gain.exponentialRampToValueAtTime(0.00001, t+0.12);
    o.start(t); o.stop(t+0.13);
  }

  // ---------- Raycaster for interactions ----------
  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();

  function screenToRay(x, y){
    const rect = renderer.domElement.getBoundingClientRect();
    mouse.x = ((x - rect.left)/rect.width)*2 - 1;
    mouse.y = -(((y - rect.top)/rect.height)*2 - 1);
    raycaster.setFromCamera(mouse, camera);
  }

  const overlay = document.getElementById('overlay');
  const overlayBg = document.getElementById('overlayBg');
  const closeOverlay = document.getElementById('closeOverlay');
  const ovTitle = document.getElementById('ovTitle');
  const ovText = document.getElementById('ovText');
  const ovImg = document.getElementById('ovImg');
  const ovCaption = document.getElementById('ovCaption');

  const casualLines = [
    "You’ve got the brightest smile in the whole garden 🌼",
    "Every step with you feels a little more magical ✨",
    "You make ordinary moments bloom like spring 🌷",
    "Found a tiny surprise—just like your tiny quirks I adore 💫",
    "I kept this one just for you; hope it makes you grin 😊",
    "You’re the gentle breeze my day was waiting for 🍃",
    "A sweet something for a sweeter you 🍫",
    "Where you go, the butterflies follow 🦋",
    "For the one who turns quiet days into cozy ones ☕",
    "A spark of happy—because you deserve it 🎁",
  ];

  function openOverlay({title, text, imgUrl, caption}){
    ovTitle.textContent = title || "Surprise";
    ovText.textContent = text || casualLines[(Math.random()*casualLines.length)|0];
    if (imgUrl){
      ovImg.src = imgUrl;
      ovImg.style.display = 'block';
    } else {
      ovImg.removeAttribute('src');
      ovImg.style.display = 'none';
    }
    ovCaption.textContent = caption || "";
    overlay.classList.add('open');
  }
  function closeOv(){ overlay.classList.remove('open'); }
  overlayBg.addEventListener('click', closeOv);
  closeOverlay.addEventListener('click', closeOv);

  // ---------- Interaction handler ----------
  function handlePick(clientX, clientY){
    screenToRay(clientX, clientY);
    const objects = [...interactGroup.children, ...hoardGroup.children];
    const hit = raycaster.intersectObjects(objects, true)[0];
    if (hit){
      // find the top-level item we tagged
      let cur = hit.object;
      while (cur && !cur.userData.type && cur.parent) cur = cur.parent;
      if (cur && cur.userData.type){
        const worldPos = new THREE.Vector3();
        cur.getWorldPosition(worldPos);
        spawnParticles(worldPos, 60, 'spark');
        if (cur.userData.type === 'gift'){
          openOverlay({ title: "A little gift for you 🎁", text: undefined });
        } else if (cur.userData.type === 'flower'){
          openOverlay({ title: "Picked a bright bloom 🌼" });
        } else if (cur.userData.type === 'candy'){
          openOverlay({ title: "Sugar rush incoming 🍬" });
        } else if (cur.userData.type === 'hoarding'){
          openOverlay({ title: "A cherished photo 📸", imgUrl: cur.userData.imgUrl, caption: "Swipe more along the path for new photos." });
        }
        chirp();
      }
    }
  }

  renderer.domElement.addEventListener('click', (e)=>{
    handlePick(e.clientX, e.clientY);
  }, {passive:true});

  renderer.domElement.addEventListener('touchstart', (e)=>{
    if (e.touches && e.touches.length===1){
      const t = e.touches[0];
      handlePick(t.clientX, t.clientY);
    }
  }, {passive:true});

  // ---------- Stars + fireflies (night) ----------
  const starGeo = new THREE.BufferGeometry();
  const STAR_N = 1200;
  const sPos = new Float32Array(STAR_N*3);
  for (let i=0;i<STAR_N;i++){
    sPos[i*3+0] = (Math.random()-0.5)*800;
    sPos[i*3+1] = 30 + Math.random()*140;
    sPos[i*3+2] = PATH_Z0 + Math.random()*WORLD_LEN;
  }
  starGeo.setAttribute('position', new THREE.BufferAttribute(sPos, 3));
  const starMat = new THREE.PointsMaterial({ size: 0.7, color: 0xffffff });
  const stars = new THREE.Points(starGeo, starMat);
  nightGroup.add(stars);

  const fireflyGeo = new THREE.BufferGeometry();
  const FIREFLY_N = 160;
  const fPos = new Float32Array(FIREFLY_N*3);
  for (let i=0;i<FIREFLY_N;i++){
    fPos[i*3+0] = (Math.random()-0.5)*120;
    fPos[i*3+1] = 0.6 + Math.random()*2.6;
    fPos[i*3+2] = PATH_Z0 + Math.random()*WORLD_LEN;
  }
  fireflyGeo.setAttribute('position', new THREE.BufferAttribute(fPos, 3));
  const fireflyMat = new THREE.PointsMaterial({ size: 0.1, color: 0xfff2a6 });
  const fireflies = new THREE.Points(fireflyGeo, fireflyMat);
  nightGroup.add(fireflies);

  // ---------- UI wiring (desktop buttons + mobile switches) ----------
  let night = false;
  let effectsOn = true;
  let birdsOn = true;
  let butterfliesOn = true;
  let soundOn = true;

  const btnDayNight = document.getElementById('btnDayNight');
  const btnEffects = document.getElementById('btnEffects');
  const btnBirds = document.getElementById('btnBirds');
  const btnButterflies = document.getElementById('btnButterflies');
  const btnSounds = document.getElementById('btnSounds');
  const btnCenter = document.getElementById('btnCenter');

  const swDayNight = document.getElementById('swDayNight');
  const swEffects = document.getElementById('swEffects');
  const swBirds = document.getElementById('swBirds');
  const swButterflies = document.getElementById('swButterflies');
  const swSounds = document.getElementById('swSounds');
  const fab = document.getElementById('fab');
  const sheet = document.getElementById('sheet');

  function applyNight(){
    scene.fog.density = night ? 0.0011 : 0.00055;
    hemi.intensity = night ? 0.25 : 0.8;
    sun.intensity = night ? 0.1 : 0.75;
    nightGroup.visible = night;
    lampGroup.children.forEach(l => { l.userData.glow.intensity = night ? 1.2 : 0; });
    document.body.style.background = night
      ? 'linear-gradient(#081226, #101b33)'
      : 'linear-gradient(#9fd3ff, #e9f9ff)';
    btnDayNight.textContent = night ? 'Night' : 'Day';
    swDayNight.checked = night;
  }

  function setToggle(btn, val){
    if (!btn) return;
    if (val) btn.classList.add('on'); else btn.classList.remove('on');
  }

  btnDayNight && btnDayNight.addEventListener('click', ()=>{ night = !night; applyNight(); });
  btnEffects && btnEffects.addEventListener('click', ()=>{ effectsOn = !effectsOn; setToggle(btnEffects, effectsOn); });
  btnBirds && btnBirds.addEventListener('click', ()=>{ birdsOn = !birdsOn; setToggle(btnBirds, birdsOn); });
  btnButterflies && btnButterflies.addEventListener('click', ()=>{ butterfliesOn = !butterfliesOn; setToggle(btnButterflies, butterfliesOn); });
  btnSounds && btnSounds.addEventListener('click', ()=>{ soundOn = !soundOn; setToggle(btnSounds, soundOn); ensureAudio(); });

  swDayNight.addEventListener('change', ()=>{ night = swDayNight.checked; applyNight(); });
  swEffects.addEventListener('change', ()=>{ effectsOn = swEffects.checked; setToggle(btnEffects, effectsOn); });
  swBirds.addEventListener('change', ()=>{ birdsOn = swBirds.checked; setToggle(btnBirds, birdsOn); });
  swButterflies.addEventListener('change', ()=>{ butterfliesOn = swButterflies.checked; setToggle(btnButterflies, butterfliesOn); });
  swSounds.addEventListener('change', ()=>{ soundOn = swSounds.checked; setToggle(btnSounds, soundOn); ensureAudio(); });

  function centerCamera(){
    camera.position.set(0, 5.2, 12);
    controls.target.set(0, 1, 0);
  }
  btnCenter && btnCenter.addEventListener('click', centerCamera);
  document.getElementById('btnCenterM').addEventListener('click', ()=>{ centerCamera(); sheet.classList.remove('open'); });

  fab.addEventListener('click', ()=>{ sheet.classList.toggle('open'); });

  // ---------- Resize ----------
  window.addEventListener('resize', onResize);
  function onResize(){
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  // ---------- Animation loop ----------
  const clock = new THREE.Clock();
  function animate(){
    requestAnimationFrame(animate);
    const t = clock.getElapsedTime();
    grassMat.uniforms.uTime.value = t;

    // butterflies
    for (const b of butterflies){
      b.userData.phase += 0.2;
      const s = Math.sin(b.userData.phase)*0.5 + 0.5;
      const [wL, wR] = b.userData.wings;
      if (wL && wR){
        wL.rotation.y = Math.sin(t*8 + b.userData.phase)*0.8;
        wR.rotation.y = -wL.rotation.y;
      }
      if (butterfliesOn){
        b.position.x += Math.sin(t*0.6 + b.userData.phase)*0.02;
        b.position.z += 0.06 + Math.sin(t*0.2 + b.userData.phase)*0.03;
        b.position.y += Math.sin(t*0.9 + b.userData.phase)*0.01;
      }
      b.visible = butterfliesOn;
    }

    // birds
    for (const b of birds){
      const [w1, w2] = b.userData.wings;
      const flap = Math.sin(t*9 + b.userData.phase)*0.5;
      if (w1 && w2) { w1.rotation.y = flap; w2.rotation.y = -flap; }
      if (birdsOn){
        b.position.x += Math.sin(t*0.3 + b.userData.phase)*0.04;
        b.position.z += 0.1 + Math.cos(t*0.1 + b.userData.phase)*0.05;
        b.position.y += Math.sin(t*0.4 + b.userData.phase)*0.03;
        // sprinkle as they pass
        if (effectsOn && Math.random()<0.006){
          const pos = b.position.clone();
          pos.y -= 0.2;
          spawnParticles(pos, 12, 'spark');
        }
        // occasional chirp
        if (Math.random()<0.002){ chirp(); }
      }
      b.visible = birdsOn;
    }

    // particle simple life fade (implicit; we just respawn so opacity constant)

    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  // ---------- Helper: safe tap-to-start sound on mobile ----------
  window.addEventListener('pointerdown', ()=>{ ensureAudio(); }, {once:true, passive:true});
})();
</script>
</body>
</html>
