<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Guddu‚Äôs Magical 3D Love Garden ‚ú®</title>
<style>
  :root{
    --ink:#eef2ff; --muted:#c8d1ff; --deep:#070a18;
    --rose:#ff7abf; --gold:#ffd98a; --mint:#9ff9cf; --aqua:#89f3ff; --vio:#c0a2ff;
  }
  html,body{margin:0;height:100%;background:radial-gradient(1200px 800px at 12% -10%, #1a1852 0%, #0c1031 45%, #070a18 85%); color:var(--ink); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  #app{position:fixed; inset:0}
  canvas{display:block}

  /* UI */
  .topbar{position:fixed; left:50%; top:10px; transform:translateX(-50%); z-index:5;
    display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center}
  .pill{padding:8px 14px; border-radius:999px; font-weight:700; font-size:13px; letter-spacing:.2px;
    background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25); backdrop-filter:blur(6px); color:#fff; cursor:pointer}
  .pill:hover{background:rgba(255,255,255,.18)}
  .toast{position:fixed; left:50%; bottom:14px; transform:translateX(-50%); z-index:6; padding:10px 14px; border-radius:10px;
    background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.25); box-shadow:0 10px 28px rgba(0,0,0,.35); font-size:13px}
  .hint{position:fixed; right:10px; bottom:10px; opacity:.7; font-size:12px; z-index:5}
  .msg{
    position:fixed; left:50%; bottom:16vh; transform:translateX(-50%); max-width:min(92vw, 820px);
    text-align:center; z-index:7; padding:12px 16px; border-radius:18px;
    background:rgba(8,10,28,.58); border:1px solid rgba(255,255,255,.2); backdrop-filter:blur(8px);
    box-shadow:0 20px 60px rgba(0,0,0,.45);
  }
  .msg h2{
    margin:0; font-family:Georgia, "Times New Roman", ui-serif; font-weight:900; letter-spacing:.3px;
    font-size:clamp(18px,5.8vw,40px); line-height:1.2;
    background:linear-gradient(90deg,#ffe4a6 0%,#ffb6e5 45%,#ffffff 100%);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow:0 0 18px rgba(255,230,170,.35), 0 0 36px rgba(255,200,200,.22);
  }
  .msg p{margin:.45rem 0 0; color:var(--muted); font-size:clamp(12px,3.6vw,18px)}
  .hidden{display:none}

  /* Loading */
  #loading{position:fixed; inset:0; display:grid; place-items:center; z-index:9; color:#fff; font-weight:800; letter-spacing:.3px;
    background: radial-gradient(800px 600px at 20% -5%, rgba(120,100,255,.20), transparent 60%)}

  /* Spark emoji */
  .spark{position:fixed; pointer-events:none; z-index:8; opacity:.92; font-size:18px; animation:rise 1.1s ease-out forwards}
  @keyframes rise{from{transform:translateY(0); opacity:.92} to{transform:translateY(-40px); opacity:0}}
</style>
</head>
<body>
<div id="loading">Preparing Guddu‚Äôs Garden‚Ä¶ ‚ú®</div>
<div id="app"></div>

<div class="topbar">
  <button id="toggleDN" class="pill" aria-label="Toggle Day / Night">üåû Day</button>
  <button id="toggleMusic" class="pill" aria-label="Toggle Music">üéµ Music: On</button>
  <button id="centerCam" class="pill" aria-label="Center camera">üéØ Center</button>
</div>
<div class="hint">Tap/Click flowers, gifts, chocolates & hoardings üå∏üéÅüç´ ‚Äî drag to explore, pinch/scroll to zoom</div>
<div id="note" class="msg hidden">
  <h2 id="noteTitle">Love Note</h2>
  <p id="noteSub">Subline</p>
</div>
<div id="toast" class="toast hidden"></div>

<!-- Audio -->
<audio id="bgm" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_3b2f6b81f5.mp3?filename=romantic-piano-ambient-110397.mp3" preload="auto" loop></audio>
<audio id="chirp" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2aa8f2e219.mp3?filename=birds-in-forest-ambient-110276.mp3" preload="auto" loop></audio>
<audio id="chime" src="https://cdn.pixabay.com/download/audio/2022/01/19/audio_2b1c1b9e1a.mp3?filename=magic-6325.mp3" preload="auto"></audio>

<!-- Your local copies (same folder): -->
<script src="three.min.js"></script>
<script src="OrbitControls.js"></script>

<script>
(function(){
  // --- Safety shims for OrbitControls old/new quaternion API ---
  if (THREE && THREE.Quaternion) {
    if (!THREE.Quaternion.prototype.inverse && THREE.Quaternion.prototype.invert) {
      THREE.Quaternion.prototype.inverse = function(){ return this.invert(); };
    }
    if (!THREE.Quaternion.prototype.invert && THREE.Quaternion.prototype.inverse) {
      THREE.Quaternion.prototype.invert = function(){ return this.inverse(); };
    }
  }
})();

(function(){
  // Small helpers
  const $ = s => document.querySelector(s);
  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');
  const toast = (t, ms=2400) => { const el=$('#toast'); el.textContent=t; show(el); clearTimeout(el._t); el._t=setTimeout(()=>hide(el), ms); };
  const rawLink = url => url.replace(/\?dl=0(?:$|)/,'?raw=1'); // dropbox direct

  // Check libs
  if (!window.THREE) {
    show($('#loading'));
    $('#loading').textContent = 'Three.js failed to load. Put three.min.js beside this HTML.';
    return;
  }
  if (!THREE.OrbitControls) {
    // Not fatal; we‚Äôll still render but without controls
    toast('OrbitControls not found. Place OrbitControls.js beside this HTML.');
  }

  let scene, camera, renderer, composer, controls;
  let raycaster, pointer, clock;
  let isNight = false;

  const app = $('#app');

  init();
  animate();

  function init(){
    clock = new THREE.Clock();
    scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x0b0f2b, 0.018);

    const w = app.clientWidth, h = app.clientHeight;
    camera = new THREE.PerspectiveCamera(60, w/h, 0.1, 1000);
    camera.position.set(0, 7, 22);

    renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
    renderer.setSize(w, h);
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    app.appendChild(renderer.domElement);

    // Lights
    const hemi = new THREE.HemisphereLight(0x9fd6ff, 0x304050, 1.0); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 1.0); dir.position.set(8,16,6); scene.add(dir);

    // Sky gradient dome
    const sky = makeSky();
    scene.add(sky);

    // Ground (procedural mottled grass look)
    const ground = makeGround();
    scene.add(ground);

    // Stone path
    scene.add(makePath());

    // Decorative bushes + trees
    scene.add(makeShrubs());
    const trees = makeTrees();
    scene.add(trees);

    // Birds (simple low-poly + chirping)
    const birds = makeBirdsOnTrees(trees);
    scene.add(birds);

    // Butterflies
    const butterflies = makeButterflies(26);
    scene.add(butterflies);

    // Center heart
    const heart = makeHeart(); scene.add(heart);

    // Flowers / Chocolates / Gifts
    const interactables = [];
    addFlowers(18, interactables);
    addChocolates(10, interactables);
    addGifts(8, interactables);

    // Hoardings (your 5 images)
    addHoardings([
      "https://www.dropbox.com/scl/fi/u98gnws5gdqjxqoln440b/IMG-20250815-WA0010.jpg?dl=0",
      "https://www.dropbox.com/scl/fi/cov38hf9qc6cy4e4c4io9/IMG-20250815-WA0000.jpg?dl=0",
      "https://www.dropbox.com/scl/fi/2mcpq9fuoqqdrfncxo17f/IMG-20250304-WA0006.jpg?dl=0",
      "https://www.dropbox.com/scl/fi/pnr4hg3cszl67aojrz5yb/IMG-20250815-WA0008.jpg?dl=0",
      "https://www.dropbox.com/scl/fi/0a1ckwv332kos7s2koy3n/IMG-20250815-WA0003.jpg?dl=0"
    ], interactables);

    // Fireflies (will be more visible at night)
    const fireflies = makeFireflies(90); scene.add(fireflies);

    // Raycaster
    raycaster = new THREE.Raycaster();
    pointer = new THREE.Vector2();
    renderer.domElement.addEventListener('pointerdown', e => onPointerDown(e, interactables, heart));

    // Controls
    if (THREE.OrbitControls) {
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; controls.dampingFactor = 0.06;
      controls.minDistance = 8; controls.maxDistance = 70;
      controls.target.set(0,3,0);
    }

    // Audio
    setupAudio();

    // UI
    $('#toggleDN').addEventListener('click', toggleDayNight);
    $('#toggleMusic').addEventListener('click', toggleMusic);
    $('#centerCam').addEventListener('click', ()=>{ if(controls){ controls.target.set(0,3,0); camera.position.set(0,7,22);} });

    // Resize
    window.addEventListener('resize', onResize);

    setTimeout(()=>$('#loading').remove(), 500);
  }

  function onResize(){
    const w=app.clientWidth, h=app.clientHeight;
    camera.aspect = w/h; camera.updateProjectionMatrix();
    renderer.setSize(w,h);
  }

  /* ---------- Scene Pieces ---------- */

  function makeSky(){
    const g = new THREE.SphereGeometry(220, 32, 32);
    const m = new THREE.ShaderMaterial({
      uniforms:{ top:{value:new THREE.Color(0x141a46)}, bottom:{value:new THREE.Color(0x050814)} },
      vertexShader:`varying vec3 vPos; void main(){ vPos=position; gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0); }`,
      fragmentShader:`varying vec3 vPos; uniform vec3 top; uniform vec3 bottom;
        void main(){ float h = normalize(vPos).y*.5+.5; gl_FragColor=vec4(mix(bottom, top, h),1.0); }`,
      side:THREE.BackSide, depthWrite:false
    });
    return new THREE.Mesh(g,m);
  }

  function makeGround(){
    // Big plane with subtle color noise for grass look
    const g = new THREE.PlaneGeometry(200, 200, 200, 200);
    const v = g.attributes.position;
    // Gentle bumps
    for (let i=0;i<v.count;i++){
      const x=v.getX(i), z=v.getZ(i);
      const y = Math.sin(x*0.05)*0.15 + Math.cos(z*0.04)*0.12;
      v.setY(i, y);
    }
    g.computeVertexNormals();
    const m = new THREE.MeshStandardMaterial({ color:0x214a2a, roughness:1, metalness:0 });
    const mesh = new THREE.Mesh(g, m);
    mesh.rotation.x = -Math.PI/2;
    mesh.position.y = 0;
    return mesh;
  }

  function makePath(){
    // Simple stone-tiled path (hex tiles placed along a curve)
    const group = new THREE.Group();
    const tileGeo = new THREE.CylinderGeometry(0.7, 0.7, 0.08, 6);
    const mat = new THREE.MeshStandardMaterial({ color:0x6d6f7a, roughness:1 });
    const N = 42;
    for (let i=0;i<N;i++){
      const t = i/(N-1);
      const x = Math.sin(t*Math.PI*2*0.35)*10;
      const z = t*36 - 18;
      const tile = new THREE.Mesh(tileGeo, mat);
      tile.position.set(x, 0.04, z);
      group.add(tile);
    }
    return group;
  }

  function makeShrubs(){
    const group = new THREE.Group();
    const green = new THREE.MeshStandardMaterial({color:0x2e7d4b, roughness:.95});
    for(let i=0;i<60;i++){
      const r = rand(12, 80), ang = rand(0, Math.PI*2);
      const x = Math.cos(ang)*r, z = Math.sin(ang)*r;
      const h = rand(0.6, 1.8);
      const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.08,0.1,h,6), new THREE.MeshStandardMaterial({color:0x6b4d2e}));
      trunk.position.set(x, h/2, z);
      const cone = new THREE.Mesh(new THREE.ConeGeometry(rand(0.4,1.2), rand(0.9,1.8), 8), green);
      cone.position.set(x, h+cone.geometry.parameters.height/2, z);
      group.add(trunk, cone);
    }
    return group;
  }

  function makeTrees(){
    const group = new THREE.Group();
    const trunkMat = new THREE.MeshStandardMaterial({color:0x5a3d24, roughness:1});
    const leafMat = new THREE.MeshStandardMaterial({color:0x2d6f3a, roughness:.9});
    for(let i=0;i<10;i++){
      const r = rand(16, 40), ang = rand(0, Math.PI*2);
      const x = Math.cos(ang)*r, z = Math.sin(ang)*r;
      const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.6, rand(5,7), 8), trunkMat);
      trunk.position.set(x, trunk.geometry.parameters.height/2, z);
      const crown = new THREE.Mesh(new THREE.IcosahedronGeometry(rand(2.2, 3.2), 0), leafMat);
      crown.position.set(x, trunk.geometry.parameters.height+1.6, z);
      group.add(trunk, crown);
    }
    return group;
  }

  function makeBirdsOnTrees(trees){
    const group = new THREE.Group();
    const bodyMat = new THREE.MeshStandardMaterial({color:0xffe3a1, roughness:.6});
    const beakMat = new THREE.MeshStandardMaterial({color:0xffa500, roughness:.6});
    const nests = [];
    trees.traverse(obj=>{
      if(obj.geometry && obj.geometry.type === 'IcosahedronGeometry'){
        nests.push(obj);
      }
    });
    const n = Math.min(6, nests.length);
    for(let i=0;i<n;i++){
      const anchor = nests[i];
      const bird = new THREE.Group();
      const body = new THREE.Mesh(new THREE.SphereGeometry(0.35, 12,12), bodyMat);
      const head = new THREE.Mesh(new THREE.SphereGeometry(0.22, 12,12), bodyMat);
      head.position.set(0.35, 0.08, 0);
      const beak = new THREE.Mesh(new THREE.ConeGeometry(0.08, 0.22, 8), beakMat);
      beak.rotation.z = -Math.PI/2; beak.position.set(0.52, 0.08, 0);
      bird.add(body, head, beak);
      bird.position.copy(anchor.position).add(new THREE.Vector3(rand(-0.6,0.6), rand(-0.4,0.6), rand(-0.6,0.6)));
      bird.userData.type='bird';
      group.add(bird);
    }
    return group;
  }

  function makeButterflies(count=20){
    const group = new THREE.Group();
    const wingGeo = new THREE.SphereGeometry(0.08, 8, 8);
    for(let i=0;i<count;i++){
      const wingMat = new THREE.MeshBasicMaterial({color:new THREE.Color().setHSL(Math.random(), 0.8, 0.75)});
      const L = new THREE.Mesh(wingGeo, wingMat);
      const R = new THREE.Mesh(wingGeo, wingMat);
      L.position.set(-0.07,0,0); R.position.set(0.07,0,0);
      const b = new THREE.Group(); b.add(L,R);
      b.position.set(rand(-16,16), rand(1.5,5.5), rand(-16,16));
      b.userData.t = rand(0, 1000);
      b.userData.type='butterfly';
      group.add(b);
    }
    return group;
  }

  function makeHeart(){
    const shape = new THREE.Shape();
    shape.moveTo(0, 0.25);
    shape.bezierCurveTo(0, 0.25, -0.3, 0, -0.6, 0.25);
    shape.bezierCurveTo(-0.9, 0.55, -0.6, 0.9, 0, 1.1);
    shape.bezierCurveTo(0.6, 0.9, 0.9, 0.55, 0.6, 0.25);
    shape.bezierCurveTo(0.3, 0, 0, 0.25, 0, 0.25);
    const geo = new THREE.ExtrudeGeometry(shape, { depth:0.4, bevelEnabled:true, bevelSize:0.06, bevelThickness:0.08, bevelSegments:6 });
    const mat = new THREE.MeshStandardMaterial({ color:0xff2a74, metalness:0.3, roughness:0.15, emissive:0x330014, emissiveIntensity:0.5});
    const mesh = new THREE.Mesh(geo, mat);
    mesh.scale.set(2.8, 2.8, 2.8);
    mesh.rotation.x = -0.28;
    mesh.position.set(0, 3.2, 0);
    mesh.userData.type='centerHeart';

    // pedestal
    const ped = new THREE.Mesh(new THREE.CylinderGeometry(1.6,1.8,0.6,24), new THREE.MeshStandardMaterial({color:0x2a2f48, roughness:1}));
    ped.position.set(0,0.3,0);
    scene.add(ped);

    // heart light for night
    const glow = new THREE.PointLight(0xff5599, 0.0, 18); // off in day; raised at night
    glow.position.set(0,3.4,1.2);
    mesh.add(glow);
    mesh.userData.glow = glow;

    return mesh;
  }

  function addFlowers(n=14, interactables){
    const messages = [
      ["Guddu, you‚Äôre my favorite bloom üå∏", "Your smile makes everything blossom."],
      ["With you, every day is spring üíê", "Forever yours ‚Äî Anuj"],
      ["You glow brighter than stars ‚ú®", "My wish is you, always."],
      ["You‚Äôre my calm & my chaos üíû", "Perfectly, beautifully you."],
      ["Your laughter is my music üé∂", "Never stop shining."],
      ["To my constant wonder üåü", "Hand in hand, always."],
      ["You are home, Guddu üè°", "In every heartbeat."],
      ["Sunrise feels jealous üåÖ", "Because you light my world."],
      ["Sweetest soul I know üçØ", "Thank you for being you."],
      ["My favorite story üìñ", "Let‚Äôs write forever."],
      ["Only and always you üíñ", "Happy birthday, beautiful."],
      ["You + Me = Magic ‚ú®", "Always, forever ‚Äî Anuj"],
      ["You‚Äôre my lucky star ‚≠ê", "Guiding me, every day."],
      ["Every petal says ‚ÄòGuddu‚Äô üå∫", "I love you endlessly."]
    ];

    for(let i=0;i<n;i++){
      const r = rand(6, 22), ang = rand(0, Math.PI*2);
      const x = Math.cos(ang)*r + rand(-8,8), z = Math.sin(ang)*r + rand(-8,8);
      const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,0.9,8), new THREE.MeshStandardMaterial({color:0x2aa84a}));
      stem.position.set(x,0.45,z);
      const petalMat = new THREE.MeshStandardMaterial({color: new THREE.Color().setHSL(Math.random(), 0.8, 0.6), emissive:0x220011, emissiveIntensity:0.2});
      const head = new THREE.Mesh(new THREE.SphereGeometry(0.22, 16, 16), petalMat);
      head.position.set(x,1.06,z);
      head.userData.type='flower';
      head.userData.baseY=head.position.y;
      head.userData.message = messages[i % messages.length];
      scene.add(stem, head);
      interactables.push(head);
    }
  }

  function addChocolates(n=8, interactables){
    const mat = new THREE.MeshStandardMaterial({color:0x4b2b1a, roughness:.75, metalness:.1, emissive:0x120800, emissiveIntensity:0.05});
    for(let i=0;i<n;i++){
      const r = rand(10, 26), ang = rand(0, Math.PI*2);
      const mesh = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.2,0.5), mat);
      mesh.position.set(Math.cos(ang)*r, 0.12, Math.sin(ang)*r);
      mesh.userData.type='choco';
      // night spotlight
      const spot = new THREE.PointLight(0xffcc88, 0.0, 8);
      spot.position.set(0,0.6,0);
      mesh.add(spot); mesh.userData.glow = spot;
      scene.add(mesh); interactables.push(mesh);
    }
  }

  function addGifts(n=6, interactables){
    for(let i=0;i<n;i++){
      const r = rand(10, 30), ang = rand(0, Math.PI*2);
      const box = new THREE.Mesh(new THREE.BoxGeometry(0.95,0.62,0.95), new THREE.MeshStandardMaterial({color:new THREE.Color().setHSL(Math.random(),.7,.6), emissive:0x111111, emissiveIntensity:0.08}));
      box.position.set(Math.cos(ang)*r, 0.31, Math.sin(ang)*r);
      const ribbon = new THREE.Mesh(new THREE.BoxGeometry(0.98,0.08,0.16), new THREE.MeshStandardMaterial({color:0xffffff, emissive:0x333333, emissiveIntensity:0.4}));
      ribbon.position.set(box.position.x, box.position.y+0.35, box.position.z);
      box.userData.type='gift';
      const glow = new THREE.PointLight(0x88b8ff, 0.0, 12);
      glow.position.set(0,0.8,0);
      box.add(glow); box.userData.glow = glow;
      scene.add(box, ribbon); interactables.push(box);
    }
  }

  function addHoardings(urls, interactables){
    const radius=18;
    const texLoader = new THREE.TextureLoader();
    urls.forEach((u,i)=>{
      const tex = texLoader.load(rawLink(u));
      tex.colorSpace = THREE.SRGBColorSpace;
      const plane = new THREE.Mesh(
        new THREE.PlaneGeometry(5.4, 7.6),
        new THREE.MeshStandardMaterial({map:tex, roughness:.9, metalness:0, emissive:0x111111, emissiveIntensity:0.15})
      );
      const angle = (i/urls.length)*Math.PI*2;
      plane.position.set(Math.cos(angle)*radius, 3.9, Math.sin(angle)*radius);
      plane.lookAt(0,3.6,0);
      plane.userData.type='hoarding';
      scene.add(plane);
      interactables.push(plane);

      // glowing frame (stronger at night)
      const frame = new THREE.Mesh(
        new THREE.PlaneGeometry(5.6, 7.8),
        new THREE.MeshBasicMaterial({color:0xffffff, transparent:true, opacity:0.06})
      );
      frame.position.copy(plane.position); frame.quaternion.copy(plane.quaternion);
      plane.userData.frame = frame;
      scene.add(frame);
    });
  }

  function makeFireflies(count=70){
    const group = new THREE.Group();
    const geo = new THREE.SphereGeometry(0.03, 6, 6);
    const mat = new THREE.MeshBasicMaterial({color:0xffffcc});
    for(let i=0;i<count;i++){
      const f = new THREE.Mesh(geo, mat);
      f.position.set(rand(-16,16), rand(1,7), rand(-16,16));
      f.userData.t = rand(0, 1000);
      f.userData.type='firefly';
      group.add(f);
    }
    return group;
  }

  /* ---------- Interaction ---------- */

  function onPointerDown(e, interactables, heart){
    const rect = renderer.domElement.getBoundingClientRect();
    pointer.x = ((e.clientX - rect.left)/rect.width)*2 - 1;
    pointer.y = -((e.clientY - rect.top)/rect.height)*2 + 1;

    raycaster.setFromCamera(pointer, camera);
    const hits = raycaster.intersectObjects(interactables, false);
    if(!hits.length){ spark(e.clientX, e.clientY); return; }
    const obj = hits[0].object;

    spark(e.clientX, e.clientY);

    if(obj.userData.type==='flower'){
      animateRise(obj);
      fairyDust(obj.position, 80, 0xffc7ff);
      const [title, sub] = obj.userData.message || ["You‚Äôre my blossom üå∏", "Always shining."];
      popNote(title, sub);
      playChime();
    } else if(obj.userData.type==='choco'){
      bump(obj); fairyDust(obj.position, 90, 0xffaa66);
      popNote("Sweetest chocolate for you üç´", "Because you‚Äôre the sweetest part of me.");
      playChime();
    } else if(obj.userData.type==='gift'){
      bump(obj); burst(obj.position, 160);
      popNote("A gift of a thousand hugs üéÅ", "Open me: it‚Äôs love, forever.");
      playChime();
    } else if(obj.userData.type==='hoarding'){
      pulse(obj); fairyDust(obj.position, 120, 0xffffff);
      popNote("Happy Birthday, Beautiful Guddu üíñ", "Keep shining like you always do!");
    }
  }

  function animateRise(head){
    const base = head.userData.baseY || head.position.y;
    const targetY = base + 0.9;
    const start = performance.now();
    (function step(t){
      const k = Math.min(1, (t-start)/650);
      head.position.y = THREE.MathUtils.lerp(head.position.y, targetY, 0.18);
      if(k<1) requestAnimationFrame(step);
    })(performance.now());
  }
  function bump(obj){
    const s0 = obj.scale.x || 1;
    let t=0; (function step(){ t+=0.14; const s = 1 + Math.sin(t)*0.18; obj.scale.setScalar(s*s0);
      if(t<Math.PI) requestAnimationFrame(step); else obj.scale.setScalar(s0); })();
  }
  function pulse(obj){
    let t=0; (function step(){ t+=0.2; const s=1+Math.sin(t)*0.12; obj.scale.setScalar(s);
      if(t<Math.PI*2) requestAnimationFrame(step); else obj.scale.setScalar(1); })();
  }

  function popNote(title, sub){
    $('#noteTitle').textContent = title;
    $('#noteSub').textContent = sub || '';
    show($('#note'));
    clearTimeout($('#note')._t);
    $('#note')._t = setTimeout(()=>hide($('#note')), 3600);
  }

  function spark(x,y,emoji='‚ú®'){
    const s=document.createElement('div'); s.className='spark'; s.textContent=emoji;
    s.style.left=x+'px'; s.style.top=y+'px'; document.body.appendChild(s);
    setTimeout(()=>s.remove(),1100);
  }

  function fairyDust(pos, count=80, color=0xffffff){
    const geo = new THREE.BufferGeometry();
    const positions = new Float32Array(count*3);
    const velocities = [];
    for(let i=0;i<count;i++){
      positions[i*3] = pos.x + rand(-0.1,0.1);
      positions[i*3+1] = pos.y + rand(-0.1,0.1);
      positions[i*3+2] = pos.z + rand(-0.1,0.1);
      const a = Math.random()*Math.PI*2, v = rand(0.6,1.8), u=rand(-0.2,0.8);
      velocities.push(new THREE.Vector3(Math.cos(a)*v, u, Math.sin(a)*v));
    }
    geo.setAttribute('position', new THREE.BufferAttribute(positions,3));
    const mat = new THREE.PointsMaterial({color, size:0.06, transparent:true, opacity:1});
    const points = new THREE.Points(geo, mat);
    scene.add(points);
    const start = performance.now();
    (function loop(t){
      const dt=(t-start)/1000, arr=geo.attributes.position.array;
      for(let i=0;i<count;i++){
        const v=velocities[i];
        arr[i*3]+=v.x*0.06; arr[i*3+1]+=v.y*0.06; arr[i*3+2]+=v.z*0.06;
        v.y -= 0.01;
      }
      geo.attributes.position.needsUpdate=true;
      mat.opacity = Math.max(0, 1 - dt*1.4);
      if(mat.opacity>0) requestAnimationFrame(loop); else { scene.remove(points); geo.dispose(); mat.dispose(); }
    })(performance.now());
  }
  function burst(pos, count=160){ fairyDust(pos, count, 0xffff88); }

  /* ---------- Audio ---------- */

  function setupAudio(){
    const bgm = $('#bgm'), chirp = $('#chirp');
    const toggleBtn = $('#toggleMusic');
    // try autoplay (may be blocked)
    const tryPlay = async (el)=>{ try{ el.muted=true; await el.play(); setTimeout(()=>{ el.muted=false; }, 200); }catch(e){} };
    tryPlay(bgm); tryPlay(chirp);

    toggleBtn.addEventListener('click', ()=>{
      if(bgm.paused){ bgm.play(); chirp.play(); toggleBtn.textContent='üéµ Music: On'; }
      else { bgm.pause(); chirp.pause(); toggleBtn.textContent='üîá Music: Off'; }
    });
  }
  function playChime(){ const c=$('#chime'); c.currentTime=0; c.play().catch(()=>{}); }

  /* ---------- Day / Night ---------- */

  function toggleDayNight(){
    isNight = !isNight;
    $('#toggleDN').textContent = isNight ? 'üåô Night' : 'üåû Day';

    // Dim whole scene at night by adjusting ambient / emissive accents
    scene.traverse(obj=>{
      if(obj.isHemisphereLight) obj.intensity = isNight ? 0.4 : 1.0;
      if(obj.isDirectionalLight) obj.intensity = isNight ? 0.5 : 1.0;
      if(obj.userData && obj.userData.glow){
        obj.userData.glow.intensity = isNight ? (obj.userData.type==='gift'? 1.6 : obj.userData.type==='choco' ? 1.2 : 1.0) : 0.0;
        if(obj.userData.type==='centerHeart'){ obj.userData.glow.intensity = isNight ? 1.4 : 0.0; }
      }
      if(obj.userData && obj.userData.frame && obj.userData.frame.material){
        obj.userData.frame.material.opacity = isNight ? 0.16 : 0.06;
      }
    });
    toast(isNight ? 'Night mode: surprises are glowing ‚ú®' : 'Day mode: butterflies out ü¶ã');
  }

  /* ---------- Animate ---------- */

  function animate(){
    requestAnimationFrame(animate);
    const t = performance.now();
    const dt = clock.getDelta();

    // Heart gentle beat
    scene.traverse(obj=>{
      if(obj.userData && obj.userData.type==='centerHeart'){
        const s = 1 + Math.sin(t*0.004)*0.06 + Math.sin(t*0.009)*0.03;
        obj.scale.set(2.8*s, 2.8*s, 2.8*s);
        obj.rotation.y += 0.003;
      }
      if(obj.userData && obj.userData.type==='butterfly'){
        obj.userData.t += 0.01;
        obj.position.x += Math.sin(obj.userData.t*2.0)*0.01;
        obj.position.y += Math.sin(obj.userData.t*1.6)*0.008;
        obj.position.z += Math.cos(obj.userData.t*1.8)*0.01;
        // wing flap
        if(obj.children[0]) obj.children[0].position.x = -0.07 + Math.sin(t*0.02)*0.04;
        if(obj.children[1]) obj.children[1].position.x = 0.07 - Math.sin(t*0.02)*0.04;
      }
      if(obj.userData && obj.userData.type==='firefly' && isNight){
        obj.userData.t += 0.014;
        obj.position.x += Math.sin(obj.userData.t*1.7)*0.012;
        obj.position.y += Math.sin(obj.userData.t*1.4)*0.010;
        obj.position.z += Math.cos(obj.userData.t*1.9)*0.012;
      }
    });

    if(controls) controls.update();
    renderer.render(scene, camera);
  }

  /* ---------- Utils ---------- */
  function rand(a,b){ return Math.random()*(b-a)+a; }

})();
</script>
</body>
</html>
