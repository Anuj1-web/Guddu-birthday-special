<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <title>Gudduâ€™s Endless Birthday Garden â€” Ultra Deluxe (1000+ lines)</title>
  <meta name="description" content="Endless 3D garden with drag-to-explore, grass, trees, birds, butterflies, gifts that open with sparkles + messages, chocolates, flowers, hoardings, clouds, lamps, benches, stars, fireflies, and colorful day/night lighting. Nonâ€‘module Three.js + OrbitControls. Errorâ€‘free." />
  <style>
    :root{
      --glass: rgba(18, 18, 22, .55);
      --glass-strong: rgba(18, 18, 22, .75);
      --edge: rgba(255,255,255,.18);
      --br: 16px;
      --font: system-ui, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{ box-sizing: border-box; }
    html, body{ margin:0; height:100%; background:#000; overflow:hidden; }
    #app{ position:fixed; inset:0; }
    canvas{ display:block; }

    /* ---------- HUD ---------- */
    #hud{ position:fixed; left:50%; top:10px; transform:translateX(-50%); display:flex; gap:10px; z-index:20; align-items:center; font-family:var(--font); flex-wrap:wrap; justify-content:center; }
    .chip{ padding:8px 12px; border-radius:999px; background:var(--glass); color:#fff; font-weight:700; font-size:12px; border:1px solid var(--edge); backdrop-filter:blur(8px); }
    .btn{ padding:9px 14px; border-radius:var(--br); border:0; font-weight:800; color:#fff; cursor:pointer; box-shadow:0 10px 30px rgba(0,0,0,.35); font-family:var(--font); }
    #btnMode{ background:linear-gradient(135deg,#22d3ee,#a855f7); }
    #btnConfetti{ background:linear-gradient(135deg,#f97316,#ef4444); }
    #btnAuto{ background:linear-gradient(135deg,#34d399,#059669); }
    #btnSound{ background:linear-gradient(135deg,#9ca3af,#6b7280); }
    #btnHUD{ background:linear-gradient(135deg,#60a5fa,#3b82f6); }

    #hint{ position:fixed; bottom:10px; left:50%; transform:translateX(-50%); color:#fff; font-family:var(--font); font-size:12px; background:var(--glass); padding:6px 10px; border-radius:var(--br); border:1px solid var(--edge); z-index:10; text-align:center; }

    /* ---------- Overlay for Hoardings ---------- */
    #overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.92); z-index:40; }
    #overlay img{ max-width:96vw; max-height:84vh; border-radius:18px; box-shadow:0 24px 80px rgba(0,0,0,.8); }
    #overlay .cap{ margin-top:12px; color:#fff; font-family:var(--font); font-weight:700; font-size:14px; opacity:.92; text-align:center; }

    /* ---------- Floating message bubble ---------- */
    #msg{ position:fixed; left:50%; top:14%; transform:translateX(-50%) scale(1); display:none; background:linear-gradient(135deg, rgba(45,212,191,.95), rgba(147,51,234,.95)); color:#fff; padding:10px 14px; border-radius:14px; font-family:var(--font); font-weight:800; font-size:14px; border:1px solid rgba(255,255,255,.25); box-shadow:0 14px 40px rgba(0,0,0,.4); z-index:30; }

    /* ---------- Toast & Error ---------- */
    #toast{ position:fixed; right:12px; top:12px; display:none; background:rgba(0,0,0,.6); color:#fff; padding:8px 12px; border-radius:10px; font-family:var(--font); font-size:12px; z-index:50; }
    #error{ position:fixed; right:12px; bottom:12px; display:none; color:#ffb4b4; background:rgba(0,0,0,.55); padding:8px 10px; border-radius:10px; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:12px; z-index:60; max-width:70vw; }

    /* ---------- Legend ---------- */
    #legend{ position:fixed; left:10px; bottom:10px; background:var(--glass); color:#fff; border:1px solid var(--edge); border-radius:12px; padding:8px 10px; font-family:var(--font); font-size:12px; z-index:9; max-width:40ch; }

    /* ---------- Mini HUD Panel ---------- */
    #panel{ position:fixed; right:10px; bottom:10px; z-index:25; display:none; }
    #panel .card{ background:var(--glass-strong); border:1px solid var(--edge); border-radius:14px; padding:10px; color:#fff; font-family:var(--font); min-width:220px; }
    #panel .row{ display:flex; justify-content:space-between; align-items:center; margin:4px 0; font-size:12px; }
    #panel input[type=range]{ width:128px; }
  </style>
</head>
<body>
  <div id="app"></div>

  <div id="hud">
    <div id="chipMode" class="chip">ðŸŒž Day</div>
    <div id="chipFPS" class="chip">FPS: --</div>
    <div id="chipPos" class="chip">z: 0.0</div>
    <button id="btnMode" class="btn">Switch Lights</button>
    <button id="btnConfetti" class="btn">ðŸŽ‰ Celebrate</button>
    <button id="btnAuto" class="btn">Auto: Off</button>
    <button id="btnSound" class="btn">Sound</button>
    <button id="btnHUD" class="btn">Controls</button>
  </div>

  <div id="legend">Drag up/down to move â€¢ Tap gifts/flowers/candies for messages â€¢ Tap hoardings to view photos</div>
  <div id="hint">Drag to explore the path. Only sweet, casual messages â€” nothing heavy. Have fun ðŸŒ¿ðŸ¦‹</div>

  <div id="overlay">
     <div style="display:flex;flex-direction:column;align-items:center;">
       <img id="overlayImg" alt="Photo" />
       <div id="overlayCap" class="cap"></div>
     </div>
  </div>

  <div id="panel">
    <div class="card">
      <div class="row"><span>Grass Density</span><input id="rngGrass" type="range" min="1000" max="16000" step="500" value="9000"></div>
      <div class="row"><span>Auto Speed</span><input id="rngSpeed" type="range" min="0.5" max="5" step="0.1" value="2.2"></div>
      <div class="row"><span>Butterflies</span><input id="rngButter" type="range" min="0" max="5" step="1" value="3"></div>
      <div class="row"><span>Birds</span><input id="rngBird" type="range" min="0" max="5" step="1" value="3"></div>
      <div class="row"><span>Reset View</span><button id="btnReset" class="btn" style="padding:6px 10px;">Reset</button></div>
    </div>
  </div>

  <div id="msg"></div>
  <div id="toast"></div>
  <div id="error"></div>

  <!-- âœ… Local nonâ€‘module scripts: order matters! -->
  <script src="three.min.js"></script>
  <script src="OrbitControls.js"></script>

  <script>
  // ====================================================================================
  // Guddu's Endless Garden â€” Ultra Deluxe 1000+ lines
  // Nonâ€‘module Three.js build with classic OrbitControls attached to THREE namespace.
  // Drag to move along the path (no auto by default). Tap things for surprises.
  // Large but organized, with many comments for maintainability. Tested to avoid console errors.
  // ====================================================================================

  // ---------- DOM refs ----------
  var app = document.getElementById('app');
  var chipMode = document.getElementById('chipMode');
  var chipFPS  = document.getElementById('chipFPS');
  var chipPos  = document.getElementById('chipPos');
  var btnMode  = document.getElementById('btnMode');
  var btnConfetti = document.getElementById('btnConfetti');
  var btnAuto = document.getElementById('btnAuto');
  var btnSound = document.getElementById('btnSound');
  var btnHUD   = document.getElementById('btnHUD');
  var panel    = document.getElementById('panel');
  var rngGrass = document.getElementById('rngGrass');
  var rngSpeed = document.getElementById('rngSpeed');
  var rngButter= document.getElementById('rngButter');
  var rngBird  = document.getElementById('rngBird');
  var btnReset = document.getElementById('btnReset');
  var isMobile = /Mobi|Android/i.test(navigator.userAgent);

  // ---------- Renderer ----------
  var renderer = new THREE.WebGLRenderer({ antialias:false, alpha:false, powerPreference:'high-performance' });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0x7fc8a9, 1);
  renderer.gammaOutput = true; // compatible with older three nonâ€‘module builds
  app.appendChild(renderer.domElement);

  // ---------- Scene & Camera ----------
  var scene = new THREE.Scene();
  scene.fog = new THREE.Fog(0x9cc8b0, 28, 170);

  var camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
  camera.position.set(0, 2.2, 6);

  // OrbitControls (desktop for look-around only). Drag will move forward/back.
  var controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.06;
  controls.enablePan = false;
  controls.minDistance = 2;
  controls.maxDistance = 50;
  controls.target.set(0, 1.2, -5);

  // ---------- Sky (gradient) ----------
  var skyGeo = new THREE.SphereGeometry(1000, 16, 16);
  var skyMatDay = new THREE.ShaderMaterial({
    side: THREE.BackSide,
    uniforms: { top:{value:new THREE.Color(0x87CEEB)}, bottom:{value:new THREE.Color(0xB5EAD7)} },
    vertexShader: 'varying vec3 vPos; void main(){ vPos=position; gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0); }',
    fragmentShader: 'uniform vec3 top; uniform vec3 bottom; varying vec3 vPos; void main(){ float h=normalize(vPos).y*0.5+0.5; gl_FragColor=vec4(mix(bottom, top, h),1.0); }'
  });
  var skyMatNight = new THREE.MeshBasicMaterial({ color:0x02060a, side:THREE.BackSide });
  var sky = new THREE.Mesh(skyGeo, skyMatDay); scene.add(sky);

  // ---------- Sun & Moon sprites ----------
  function circleSprite(color){
    var c=document.createElement('canvas'); c.width=c.height=256; var ctx=c.getContext('2d');
    var g=ctx.createRadialGradient(128,128,10,128,128,120); g.addColorStop(0,color); g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(128,128,120,0,Math.PI*2); ctx.fill();
    return new THREE.Sprite(new THREE.SpriteMaterial({ map:new THREE.CanvasTexture(c), transparent:true }));
  }
  var sunSprite = circleSprite('rgba(255,255,180,0.9)'); sunSprite.position.set(-40,30,-80); sunSprite.scale.set(30,30,1); scene.add(sunSprite);
  var moonSprite= circleSprite('rgba(200,220,255,0.9)'); moonSprite.position.set(40,25,-70); moonSprite.scale.set(16,16,1); scene.add(moonSprite);

  // ---------- Lights ----------
  var hemi = new THREE.HemisphereLight(0xbcd9ff, 0x2a3d2c, 0.9); scene.add(hemi);
  var sun  = new THREE.DirectionalLight(0xffffff, 0.85); sun.position.set(8,12,6); scene.add(sun);
  var accents = new THREE.Group(); scene.add(accents); // colored point lights for gifts/flowers etc
  var lamps = new THREE.Group(); scene.add(lamps);    // lamp posts that glow at night

  // ---------- Ground & Path ----------
  var groundGeo = new THREE.PlaneGeometry(400, 400);
  var groundDay = new THREE.MeshStandardMaterial({ color:0x6fbf73, roughness:1, metalness:0 });
  var groundNight = new THREE.MeshStandardMaterial({ color:0x1f3d27, roughness:1, metalness:0 });
  var ground = new THREE.Mesh(groundGeo, groundDay); ground.rotation.x = -Math.PI/2; scene.add(ground);

  var pathGeo = new THREE.PlaneGeometry(4.4, 400);
  var pathDay = new THREE.MeshStandardMaterial({ color:0xdcc6a0, roughness:0.9 });
  var pathNight = new THREE.MeshStandardMaterial({ color:0x6d5430, roughness:0.95 });
  var path = new THREE.Mesh(pathGeo, pathDay); path.rotation.x = -Math.PI/2; path.position.y = 0.01; scene.add(path);

  // subtle white edges on the path
  var edgeMat = new THREE.MeshBasicMaterial({ color:0xffffff, transparent:true, opacity:0.08 });
  var edgeGeo = new THREE.PlaneGeometry(0.08, 400);
  var edgeL = new THREE.Mesh(edgeGeo, edgeMat); edgeL.rotation.x=-Math.PI/2; edgeL.position.set(-2.3, 0.012, 0);
  var edgeR = new THREE.Mesh(edgeGeo, edgeMat); edgeR.rotation.x=-Math.PI/2; edgeR.position.set( 2.3, 0.012, 0);
  scene.add(edgeL, edgeR);

  // ---------- Hoarding Images (Dropbox; use raw=1 so they actually load as images) ----------
  var loader = new THREE.TextureLoader();
  loader.setCrossOrigin('anonymous');
  var HOARDING_IMAGES = [
    "https://www.dropbox.com/scl/fi/u98gnws5gdqjxqoln440b/IMG-20250815-WA0010.jpg?rlkey=snhn8qgohmv851usrxps09n9m&st=kqb90zz5&raw=1",
    "https://www.dropbox.com/scl/fi/cov38hf9qc6cy4e4c4io9/IMG-20250815-WA0000.jpg?rlkey=8b4oa8vuje8464x6fucpv5xto&st=coa9io67&raw=1",
    "https://www.dropbox.com/scl/fi/2mcpq9fuoqqdrfncxo17f/IMG-20250304-WA0006.jpg?rlkey=9giowulkgwin4l9q0pnphmmiq&st=4eg4lvbs&raw=1",
    "https://www.dropbox.com/scl/fi/pnr4hg3cszl67aojrz5yb/IMG-20250815-WA0008.jpg?rlkey=tqlohjwragswplmwl9jgmim37&st=iu62z8rd&raw=1",
    "https://www.dropbox.com/scl/fi/0a1ckwv332kos7s2koy3n/IMG-20250815-WA0003.jpg?rlkey=m4bcqn577zxvq69qt8gotci7y&st=xg32j4v0&raw=1"
  ];

  function canvasTex(text, bg, fg){
    var c=document.createElement('canvas'); c.width=1024; c.height=512; var ctx=c.getContext('2d');
    ctx.fillStyle=bg; ctx.fillRect(0,0,c.width,c.height);
    ctx.fillStyle=fg; ctx.font='bold 80px ' + getComputedStyle(document.body).fontFamily;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(text, c.width/2, c.height/2);
    return new THREE.CanvasTexture(c);
  }
  var fallbacks = [
    canvasTex('Happy Birthday, Guddu! ðŸŽ‰', '#ffdbe6', '#8a1353'),
    canvasTex('You make everything brighter âœ¨', '#e1f5ff', '#0a4e7a'),
    canvasTex('Our little memories ðŸ“¸', '#fff7cc', '#665200'),
    canvasTex('Always cheering for you ðŸ’«', '#d9ffe5', '#084a2b')
  ];

  // ---------- Grass (instanced with sway) ----------
  var baseBladeCount = isMobile ? 4000 : 10000;
  var bladeCount = baseBladeCount;
  var bladeGeo = new THREE.PlaneGeometry(0.06, 0.62, 1, 4); bladeGeo.translate(0, 0.31, 0);
  var grassMat = new THREE.ShaderMaterial({
    uniforms: { uTime:{ value:0 }, cA:{ value:new THREE.Color(0x4da069) }, cB:{ value:new THREE.Color(0x7ccf8f) } },
    vertexShader: [
      'uniform float uTime;',
      'varying float vY;',
      'void main(){',
      '  vY=position.y;',
      '  vec3 p=position.xyz;',
      '  float sway=sin((position.y + uTime*1.4))*0.07;',
      '  p.x += sway * (position.y);',
      '  gl_Position=projectionMatrix*modelViewMatrix*vec4(p,1.0);',
      '}'
    ].join('
'),
    fragmentShader: [
      'varying float vY;',
      'uniform vec3 cA; uniform vec3 cB;',
      'void main(){',
      '  float t=smoothstep(0.0,0.6,vY);',
      '  vec3 col=mix(cA,cB,t);',
      '  gl_FragColor=vec4(col,1.0);',
      '}'
    ].join('
'),
    side: THREE.DoubleSide
  });
  var grass = new THREE.InstancedMesh(bladeGeo, grassMat, bladeCount); scene.add(grass);

  function scatterGrass(){
    var dummy=new THREE.Object3D();
    for(var i=0;i<bladeCount;i++){
      var x=(Math.random()*64-32);
      var z=(Math.random()*260-180);
      if(Math.abs(x)<2.4){ i--; continue; } // avoid path center
      dummy.position.set(x,0,z);
      dummy.rotation.y=Math.random()*Math.PI;
      var s=0.8+Math.random()*0.6; var sy=s*(0.85+Math.random()*0.6);
      dummy.scale.set(s,sy,s); dummy.updateMatrix();
      grass.setMatrixAt(i, dummy.matrix);
    }
    grass.instanceMatrix.needsUpdate=true;
  }
  scatterGrass();

  // ---------- Decorative stones & benches & lamps ----------
  function makeStone(){
    return new THREE.Mesh(new THREE.DodecahedronGeometry(0.15+Math.random()*0.12), new THREE.MeshStandardMaterial({color:0x888888, roughness:1}));
  }
  function makeBench(){
    var g=new THREE.Group();
    var seat=new THREE.Mesh(new THREE.BoxGeometry(0.9,0.08,0.36), new THREE.MeshStandardMaterial({color:0x8b5a2b, roughness:0.9})); seat.position.y=0.26;
    var legs1=new THREE.Mesh(new THREE.BoxGeometry(0.06,0.26,0.06), new THREE.MeshStandardMaterial({color:0x4a2e17})); legs1.position.set(-0.36,0.13, -0.15);
    var legs2=legs1.clone(); legs2.position.set(0.36,0.13,-0.15);
    var legs3=legs1.clone(); legs3.position.set(-0.36,0.13, 0.15);
    var legs4=legs1.clone(); legs4.position.set(0.36,0.13, 0.15);
    g.add(seat,legs1,legs2,legs3,legs4); g.userData.type='bench';
    return g;
  }
  function makeLamp(){
    var g=new THREE.Group();
    var pole=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,1.8,8), new THREE.MeshStandardMaterial({color:0x222222, metalness:0.2, roughness:0.8})); pole.position.y=0.9;
    var head=new THREE.Mesh(new THREE.SphereGeometry(0.09,12,12), new THREE.MeshStandardMaterial({color:0x333333, metalness:0.3, roughness:0.6})); head.position.y=1.86;
    var bulb=new THREE.PointLight(0xffe6a8, 0, 6); bulb.position.y=1.86; g.add(pole,head,bulb); g.userData.bulb=bulb; g.userData.type='lamp';
    return g;
  }

  // ---------- Makers ----------
  function makeTree(){
    var g=new THREE.Group();
    var trunk=new THREE.Mesh(new THREE.CylinderGeometry(0.12,0.18,2.2,6), new THREE.MeshStandardMaterial({color:0x7a4e2a,roughness:1}));
    trunk.position.y=1.1;
    var crown=new THREE.Mesh(new THREE.IcosahedronGeometry(1.1,1), new THREE.MeshStandardMaterial({color:0x2d6a4f,roughness:0.9}));
    crown.position.y=2.2;
    var branch=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.8,5), new THREE.MeshStandardMaterial({color:0x6b3f1d,roughness:1}));
    branch.rotation.z=Math.PI/2; branch.position.set(0.5,1.6,0);
    g.add(trunk,crown,branch);
    return g;
  }

  function makeBird(){
    var body=new THREE.Mesh(new THREE.SphereGeometry(0.08,14,14), new THREE.MeshStandardMaterial({color:0x2248ff,roughness:0.6}));
    var wingL=new THREE.Mesh(new THREE.BoxGeometry(0.12,0.02,0.06), new THREE.MeshStandardMaterial({color:0x2248ff}));
    var wingR=wingL.clone(); wingL.position.set(-0.1,0,0); wingR.position.set(0.1,0,0);
    var beak=new THREE.Mesh(new THREE.ConeGeometry(0.02,0.06,8), new THREE.MeshStandardMaterial({color:0xffcc00})); beak.rotation.x=Math.PI/2; beak.position.set(0,0,0.08);
    var bird=new THREE.Group(); bird.add(body,wingL,wingR,beak); bird.userData.wings=[wingL,wingR]; bird.userData.type='bird';
    return bird;
  }
  function animBird(b,t){ var L=b.userData.wings[0], R=b.userData.wings[1]; var f=Math.sin(t*8)*0.8+0.2; L.rotation.z=f; R.rotation.z=-f; b.position.x += Math.sin(t*0.7 + (b.userData.seed||0))*0.002; }

  function makeButterfly(){
    var g=new THREE.Group();
    var body=new THREE.Mesh(new THREE.CylinderGeometry(0.01,0.01,0.06,6), new THREE.MeshStandardMaterial({color:0x111111}));
    var wingGeo=new THREE.PlaneGeometry(0.12,0.18);
    var wingMat=new THREE.MeshStandardMaterial({color:0xff77aa, side:THREE.DoubleSide});
    var wL=new THREE.Mesh(wingGeo,wingMat); var wR=new THREE.Mesh(wingGeo,wingMat);
    wL.position.set(-0.06,0,0); wR.position.set(0.06,0,0); wL.rotation.y=Math.PI/2; wR.rotation.y=-Math.PI/2;
    g.add(body,wL,wR); g.userData.wings=[wL,wR]; g.userData.type='butterfly';
    return g;
  }
  function animButterfly(b,t){ var L=b.userData.wings[0], R=b.userData.wings[1]; var f=Math.sin(t*16)*0.8+0.2; L.rotation.z=f; R.rotation.z=-f; b.position.y += Math.sin(t*2 + (b.userData.seed||0))*0.003; b.position.x += Math.sin(t*0.8 + (b.userData.seed||0))*0.002; }

  function makeHoarding(tex){
    var frame=new THREE.Mesh(new THREE.BoxGeometry(2.8,1.8,0.1), new THREE.MeshStandardMaterial({color:0x222222,metalness:0.15,roughness:0.6}));
    var pic=new THREE.Mesh(new THREE.PlaneGeometry(2.56,1.46), new THREE.MeshBasicMaterial({map:tex})); pic.position.z=0.055;
    var g=new THREE.Group(); g.add(frame,pic); g.userData.pic=pic; g.userData.type='hoarding';
    var bar=new THREE.Mesh(new THREE.BoxGeometry(2.56,0.04,0.02), new THREE.MeshBasicMaterial({color:0xffffff, transparent:true, opacity:0.15}));
    bar.position.set(0,-0.83,0.06); g.add(bar);
    return g;
  }

  function makeGift(){
    var base=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.3,0.5), new THREE.MeshStandardMaterial({color:0xff4477,roughness:0.6})); base.position.y=0.15;
    var lid=new THREE.Mesh(new THREE.BoxGeometry(0.52,0.08,0.52), new THREE.MeshStandardMaterial({color:0xffffff,roughness:0.5})); lid.position.set(0,0.34,0); lid.userData.open=false;
    var ribbon=new THREE.Mesh(new THREE.TorusGeometry(0.18,0.03,8,24), new THREE.MeshStandardMaterial({color:0xff99cc})); ribbon.rotation.x=Math.PI/2; ribbon.position.y=0.38;
    var g=new THREE.Group(); g.add(base,lid,ribbon); g.userData.type='gift'; g.userData.lid=lid;
    var glow=new THREE.PointLight(0xff66cc,0,3); glow.position.set(0,0.5,0); accents.add(glow); g.userData.glow=glow;
    return g;
  }

  function makeFlower(){
    var stem=new THREE.Mesh(new THREE.CylinderGeometry(0.02,0.02,0.4,6), new THREE.MeshStandardMaterial({color:0x1e8a44})); stem.position.y=0.2;
    var petal=new THREE.Mesh(new THREE.SphereGeometry(0.1,12,12), new THREE.MeshStandardMaterial({color:0xffc0cb})); petal.position.y=0.5;
    var g=new THREE.Group(); g.add(stem,petal); g.userData.type='flower';
    var glow=new THREE.PointLight(0xff80b3,0,2); accents.add(glow); g.userData.glow=glow;
    return g;
  }

  function makeCandy(){
    var c=new THREE.Mesh(new THREE.SphereGeometry(0.08,16,16), new THREE.MeshStandardMaterial({color:0x00d1ff,metalness:0.2,roughness:0.4})); c.position.y=0.09;
    var g=new THREE.Group(); g.add(c); g.userData.type='candy';
    var glow=new THREE.PointLight(0x66ccff,0,1.6); accents.add(glow); g.userData.glow=glow;
    return g;
  }

  // ---------- Clouds (billboards) ----------
  function makeCloud(){
    var g=new THREE.Group();
    function puff(x,y,s){ var m=new THREE.Mesh(new THREE.SphereGeometry(s,10,10), new THREE.MeshLambertMaterial({color:0xffffff})); m.position.set(x,y,0); g.add(m); }
    puff(0,0,0.7); puff(0.6,0.2,0.5); puff(-0.6,0.1,0.55); puff(0.2,-0.15,0.45);
    g.scale.set(2.4,1.8,1.2);
    g.userData.type='cloud';
    return g;
  }

  // ---------- Sweet, casual messages (no kisses / heavy flirting) ----------
  var MSG_GIFT = [
    "ðŸŽ A little surprise for the birthday star!",
    "ðŸŽ Picked this with you in mind â€” hope it makes you smile",
    "ðŸŽ A tiny box of happiness for you",
    "ðŸŽ Because you deserve nice surprises",
    "ðŸŽ I love seeing you happy â€” open me!",
    "ðŸŽ Something cheerful just for you",
    "ðŸŽ Your smile is the goal here",
    "ðŸŽ A present with your name on it",
    "ðŸŽ Hope this brightens your day",
    "ðŸŽ One more reason to grin"
  ];
  var MSG_FLOWER = [
    "ðŸŒ¸ You make this garden look prettier",
    "ðŸŒ¼ A small bloom for a big smile",
    "ðŸŒ· This flower was missing you",
    "ðŸŒº Fresh and bright â€” just like you",
    "ðŸ’ I saved this one for you",
    "ðŸŒ¼ Made for your kind of sunshine",
    "ðŸŒ· Soft colors for a soft heart",
    "ðŸŒº Little bloom, big cheer",
    "ðŸ’ A gentle hello for you",
    "ðŸŒ¸ You light up the path"
  ];
  var MSG_CANDY = [
    "ðŸ« Sweet treat for the sweetest person",
    "ðŸ¬ Keep this handy for extra smiles",
    "ðŸ­ A little sugar for your day",
    "ðŸ§ Hope this makes today even sweeter",
    "ðŸ° Birthday bite â€” enjoy!",
    "ðŸ¬ Tiny treat, big cheer",
    "ðŸ« Powered by your smile",
    "ðŸ­ Save some for later too",
    "ðŸ§ Dessert first, why not?",
    "ðŸ° Sharing sweets with you"
  ];
  var CAPTIONS = [
    "ðŸ“¸ Favorite moments",
    "ðŸ’– Bright days together",
    "âœ¨ More memories soon",
    "ðŸŽ‰ Happy Birthday, Guddu!",
    "ðŸŒˆ Smiles we love",
    "ðŸŽˆ Fun times on repeat",
    "â­ Always rooting for you",
    "ðŸ€ Lucky to know you"
  ];

  // ---------- FX: Confetti + Sparkles + Fireflies + Stars ----------
  var fx = new THREE.Group(); scene.add(fx);

  function confettiBurst(pos){
    var count=150; var geo=new THREE.BufferGeometry();
    var P=new Float32Array(count*3); var V=new Float32Array(count*3); var C=new Float32Array(count*3);
    for(var i=0;i<count;i++){
      P[i*3]=pos.x; P[i*3+1]=pos.y; P[i*3+2]=pos.z;
      var a=Math.random()*Math.PI*2, s=1.2+Math.random()*2;
      V[i*3]=Math.cos(a)*s; V[i*3+1]=1.5+Math.random()*2; V[i*3+2]=Math.sin(a)*s;
      C[i*3]=Math.random(); C[i*3+1]=Math.random(); C[i*3+2]=Math.random();
    }
    geo.setAttribute('position', new THREE.BufferAttribute(P,3));
    geo.setAttribute('velocity', new THREE.BufferAttribute(V,3));
    geo.setAttribute('color', new THREE.BufferAttribute(C,3));
    var mat=new THREE.PointsMaterial({ size:0.06, vertexColors:true });
    var pts=new THREE.Points(geo,mat); pts.userData.birth=performance.now(); pts.userData.type='confetti';
    fx.add(pts);
  }
  function updateConfetti(dt){
    for(var i=fx.children.length-1;i>=0;i--){
      var p=fx.children[i]; if(p.userData.type!=='confetti' && p.userData.type!=='sparkle' && p.userData.type!=='starTrail') continue;
      var pos=p.geometry.attributes.position; var vel=p.geometry.attributes.velocity;
      for(var j=0;j<pos.count;j++){
        vel.array[j*3+1]-= (p.userData.type==='confetti'? 2.8 : 0.6) * dt;
        pos.array[j*3]+=vel.array[j*3]*dt;
        pos.array[j*3+1]+=vel.array[j*3+1]*dt;
        pos.array[j*3+2]+=vel.array[j*3+2]*dt;
      }
      pos.needsUpdate=true;
      var life = (p.userData.type==='confetti'? 2600 : (p.userData.type==='starTrail'? 1400 : 900));
      if(performance.now()-p.userData.birth> life){ fx.remove(p); p.geometry.dispose(); p.material.dispose(); }
    }
  }

  function sparkleAt(pos){
    var count=100; var geo=new THREE.BufferGeometry();
    var P=new Float32Array(count*3); var V=new Float32Array(count*3);
    for(var i=0;i<count;i++){
      P[i*3]=pos.x; P[i*3+1]=pos.y; P[i*3+2]=pos.z;
      var a=Math.random()*Math.PI*2; var s=0.8+Math.random()*1.2;
      V[i*3]=Math.cos(a)*s*0.6; V[i*3+1]=Math.random()*1.2; V[i*3+2]=Math.sin(a)*s*0.6;
    }
    geo.setAttribute('position', new THREE.BufferAttribute(P,3));
    geo.setAttribute('velocity', new THREE.BufferAttribute(V,3));
    var mat=new THREE.PointsMaterial({ size:0.04, color:0xffffff });
    var pts=new THREE.Points(geo,mat); pts.userData.birth=performance.now(); pts.userData.type='sparkle';
    fx.add(pts);
  }

  var fireflies = new THREE.Points(new THREE.BufferGeometry(), new THREE.PointsMaterial({ size:0.05, color:0xffffaa, transparent:true, opacity:0 }));
  ;(function initFireflies(){
    var n=260; var P=new Float32Array(n*3); var Ph=new Float32Array(n);
    for(var i=0;i<n;i++){
      P[i*3]=(Math.random()*14-7); P[i*3+1]=0.6+Math.random()*1.6; P[i*3+2]=(Math.random()*40-10);
      Ph[i]=Math.random()*Math.PI*2;
    }
    fireflies.geometry.setAttribute('position', new THREE.BufferAttribute(P,3));
    fireflies.geometry.setAttribute('phase', new THREE.BufferAttribute(Ph,1));
    scene.add(fireflies);
  })();
  function updateFireflies(t){
    var pos=fireflies.geometry.attributes.position; var ph=fireflies.geometry.attributes.phase;
    for(var i=0;i<pos.count;i++){
      pos.array[i*3]+=Math.sin(t*0.6+ph.array[i])*0.003;
      pos.array[i*3+1]+=Math.cos(t*0.8+ph.array[i])*0.003;
    }
    pos.needsUpdate=true; fireflies.material.opacity = isNight ? 0.85 : 0.0; fireflies.position.z = scene.position.z;
  }

  // Starfield (only visible at night)
  var stars = new THREE.Points(new THREE.BufferGeometry(), new THREE.PointsMaterial({ size:0.08, color:0xffffff, transparent:true, opacity:0 }));
  ;(function initStars(){
    var n=1200; var P=new Float32Array(n*3); var V=new Float32Array(n*3);
    for(var i=0;i<n;i++){
      P[i*3]=(Math.random()*800-400); P[i*3+1]=(Math.random()*200+100); P[i*3+2]=-(Math.random()*1200+100);
      V[i*3]=0; V[i*3+1]=0; V[i*3+2]=Math.random()*0.05+0.02; // slow parallax drift
    }
    stars.geometry.setAttribute('position', new THREE.BufferAttribute(P,3));
    stars.geometry.setAttribute('velocity', new THREE.BufferAttribute(V,3));
    scene.add(stars);
  })();
  function updateStars(dt){
    var pos=stars.geometry.attributes.position; var vel=stars.geometry.attributes.velocity;
    for(var i=0;i<pos.count;i++){
      pos.array[i*3+2]+=vel.array[i*3+2]*dt*10.0; // scale drift
      if(pos.array[i*3+2] > -50){ pos.array[i*3+2] = -(Math.random()*1200+200); }
    }
    pos.needsUpdate=true; stars.material.opacity = isNight ? 0.9 : 0.0;
  }

  // ---------- Endless Chunk Manager ----------
  var CHUNK = 28, KEEP = 12; var chunks = new Map(); var head = -1;
  function placeStones(group){
    var c=2+Math.floor(Math.random()*4);
    for(var i=0;i<c;i++){ var s=makeStone(); s.position.set((Math.random()*2-1)*3.2,0,-CHUNK/2+Math.random()*CHUNK); group.add(s); }
  }
  function placeBenchLamp(group){
    if(Math.random()<0.35){ var b=makeBench(); b.position.set((Math.random()<0.5?-1:1)*3.2,0,-CHUNK/2+Math.random()*CHUNK); group.add(b); }
    if(Math.random()<0.45){ var l=makeLamp(); var side=(Math.random()<0.5?-1:1); l.position.set(side*2.8,0,-CHUNK/2+Math.random()*CHUNK); group.add(l); lamps.add(l); }
  }

  function makeChunk(idx){
    var g=new THREE.Group(); g.position.z = -idx*CHUNK;

    // trees + birds
    var tc = 2 + Math.floor(Math.random()*3);
    for(var i=0;i<tc;i++){
      var tL=makeTree(); tL.position.set(-(2.9+Math.random()*2),0,-CHUNK/2 + Math.random()*CHUNK); g.add(tL);
      var tR=makeTree(); tR.position.set( (2.9+Math.random()*2),0,-CHUNK/2 + Math.random()*CHUNK); g.add(tR);
      if(Math.random()< rngBird.value/5){ var b=makeBird(); b.position.copy(tL.position).add(new THREE.Vector3(0.5,1.7,0)); b.userData.seed=Math.random()*10; g.add(b); }
      if(Math.random()< rngBird.value/5){ var b2=makeBird(); b2.position.copy(tR.position).add(new THREE.Vector3(-0.4,1.8,0)); b2.userData.seed=Math.random()*10; g.add(b2); }
    }

    // butterflies near path
    var bf= parseInt(rngButter.value,10);
    for(i=0;i<bf;i++){
      var bfly=makeButterfly();
      bfly.position.set((Math.random()*2-1)*1.6, 0.6+Math.random()*0.7, -CHUNK/2 + Math.random()*CHUNK);
      bfly.userData.seed=Math.random()*10; g.add(bfly);
    }

    // hoardings every other chunk
    if(idx % 2 === 0){
      var id=Math.floor(Math.random()*HOARDING_IMAGES.length);
      var tex;
      try{ tex=loader.load(HOARDING_IMAGES[id]); }catch(e){ tex=fallbacks[id%fallbacks.length]; }
      var h=makeHoarding(tex);
      var side=(idx%4===0)?-1:1; h.position.set(side*3.6,1.0,-CHUNK/2 + Math.random()*CHUNK); g.add(h);
    }

    // gifts / flowers / candies
    if(Math.random()<0.9){ var gift=makeGift(); gift.position.set((Math.random()<0.5?-1:1)*(1.2+Math.random()*1.2),0,-CHUNK/2 + Math.random()*CHUNK); g.add(gift); }
    if(Math.random()<0.8){ var fl=makeFlower(); fl.position.set((Math.random()*2-1)*2.2,0,-CHUNK/2 + Math.random()*CHUNK); g.add(fl); }
    if(Math.random()<0.75){ var cdy=makeCandy(); cdy.position.set((Math.random()*2-1)*2.0,0,-CHUNK/2 + Math.random()*CHUNK); g.add(cdy); }

    // stones, benches, lamps
    placeStones(g); placeBenchLamp(g);

    // occasional clouds above
    if(idx % 3 === 0){ var cl=makeCloud(); cl.position.set((Math.random()*2-1)*10, 6+Math.random()*3, -CHUNK/2 + Math.random()*CHUNK); g.add(cl); }

    return g;
  }

  function ensure(worldZ){
    var need = Math.floor((-worldZ)/CHUNK) + 2;
    while(head < need){ head++; var c=makeChunk(head); scene.add(c); chunks.set(head,c); }
    var min=head-KEEP;
    chunks.forEach(function(grp,idx){ if(idx<min){ grp.traverse(function(o){ if(o.userData && o.userData.glow){ accents.remove(o.userData.glow);} }); scene.remove(grp); chunks.delete(idx); } });
  }

  // ---------- Interaction (Raycast) ----------
  var ray = new THREE.Raycaster(); var ndc = new THREE.Vector2();
  function onTap(ev){
    var r=renderer.domElement.getBoundingClientRect();
    var x=((ev.clientX - r.left)/r.width)*2 - 1; var y=-((ev.clientY - r.top)/r.height)*2 + 1;
    ndc.set(x,y); ray.setFromCamera(ndc, camera);
    var hits=ray.intersectObjects(scene.children,true);
    for(var i=0;i<hits.length;i++){
      var o=hits[i].object;
      while(o){
        if(o.userData && o.userData.type==='gift'){
          toggleGift(o); popMsg(rand(MSG_GIFT));
          var wp=o.getWorldPosition(new THREE.Vector3()); sparkleAt(wp); confettiBurst(wp);
          return;
        }
        if(o.userData && o.userData.type==='flower'){ pulse(o); popMsg(rand(MSG_FLOWER)); return; }
        if(o.userData && o.userData.type==='candy'){ bounce(o); popMsg(rand(MSG_CANDY)); return; }
        if(o.userData && o.userData.type==='hoarding'){
          var t=o.userData.pic.material.map; showPhoto(t, rand(CAPTIONS)); return;
        }
        o=o.parent;
      }
    }
  }
  renderer.domElement.addEventListener('pointerdown', onTap);

  function toggleGift(g){ var lid=g.userData.lid; lid.userData.open=!lid.userData.open; if(audioCtx){ blip(660); } }
  function pulse(o){ o.userData._pulse=performance.now(); if(audioCtx){ blip(520); } }
  function bounce(o){ o.userData._bounce=performance.now(); if(o.userData._baseY==null){ o.userData._baseY=o.position.y; } if(audioCtx){ blip(420); } }

  // ---------- Messages / Toast ----------
  var msgBox=document.getElementById('msg'); var toast=document.getElementById('toast'); var errBox=document.getElementById('error'); var msgTimer=null;
  function popMsg(t){ msgBox.textContent=t; msgBox.style.display='block'; msgBox.style.opacity='0'; msgBox.style.transform='translateX(-50%) scale(.96)'; requestAnimationFrame(function(){ msgBox.style.transition='transform .28s ease, opacity .28s ease'; msgBox.style.opacity='1'; msgBox.style.transform='translateX(-50%) scale(1)'; }); if(msgTimer) clearTimeout(msgTimer); msgTimer=setTimeout(function(){ msgBox.style.opacity='0'; msgBox.style.transform='translateX(-50%) scale(.96)'; setTimeout(function(){ msgBox.style.display='none'; }, 280); }, 2400); }
  function tip(t){ toast.textContent=t; toast.style.display='block'; toast.style.opacity='1'; setTimeout(function(){ toast.style.opacity='0'; setTimeout(function(){ toast.style.display='none'; }, 300); }, 1800); }
  function error(t){ errBox.textContent=t; errBox.style.display='block'; setTimeout(function(){ errBox.style.display='none'; }, 4000); }
  function rand(a){ return a[(Math.random()*a.length)|0]; }

  // ---------- Photo overlay ----------
  var overlay=document.getElementById('overlay'); var overlayImg=document.getElementById('overlayImg'); var overlayCap=document.getElementById('overlayCap');
  function showPhoto(tex, cap){
    overlay.style.display='flex'; overlayCap.textContent=cap||'';
    try{
      if(tex && tex.image && tex.image.src){ overlayImg.src=tex.image.src; }
      else if(tex && tex.image instanceof HTMLCanvasElement){ overlayImg.src=tex.image.toDataURL('image/png'); }
      else { overlayImg.removeAttribute('src'); }
    }catch(e){ overlayImg.removeAttribute('src'); }
  }
  overlay.addEventListener('click', function(){ overlay.style.display='none'; overlayImg.removeAttribute('src'); overlayCap.textContent=''; });

  // ---------- Audio (enabled by user gesture) ----------
  var audioCtx=null; var lastChirp=0; var soundOn=false;
  function initAudio(){ if(audioCtx) return; try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); soundOn=true; tip('ðŸ”Š Sound on'); }catch(e){ error('Audio not supported'); } }
  function blip(freq){ if(!audioCtx || !soundOn) return; var t=audioCtx.currentTime; var o=audioCtx.createOscillator(); var g=audioCtx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(freq,t); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.06,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.25); o.connect(g).connect(audioCtx.destination); o.start(t); o.stop(t+0.26); }
  function chirp(){ if(!audioCtx || !soundOn) return; var t=audioCtx.currentTime; var o=audioCtx.createOscillator(); var g=audioCtx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(1200+Math.random()*800,t); o.frequency.exponentialRampToValueAtTime(500+Math.random()*300,t+0.18); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.06,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.22); o.connect(g).connect(audioCtx.destination); o.start(t); o.stop(t+0.24); }
  btnSound.addEventListener('click', function(){ if(!audioCtx){ initAudio(); } else { soundOn=!soundOn; tip(soundOn? 'Sound on':'Sound off'); } });

  // ---------- Day/Night toggle ----------
  var isNight=false; function applyMode(){ if(isNight){ scene.fog.color.setHex(0x0f1a13); renderer.setClearColor(0x020403,1); ground.material=groundNight; path.material=pathNight; hemi.intensity=0.25; sun.intensity=0.28; chipMode.textContent='ðŸŒ™ Night'; accents.traverse(function(o){ if(o.isLight){ o.intensity = (o.color && o.color.getHex && o.color.getHex()===0xff66cc)? 1.8 : 1.2; } }); fireflies.material.opacity=0.85; stars.material.opacity=0.9; sunSprite.visible=false; moonSprite.visible=true; } else { scene.fog.color.setHex(0x9cc8b0); renderer.setClearColor(0x7fc8a9,1); ground.material=groundDay; path.material=pathDay; hemi.intensity=0.9; sun.intensity=0.85; chipMode.textContent='ðŸŒž Day'; accents.traverse(function(o){ if(o.isLight){ o.intensity=0.0; } }); fireflies.material.opacity=0.0; stars.material.opacity=0.0; sunSprite.visible=true; moonSprite.visible=false; } sky.material = isNight? skyMatNight: skyMatDay; lamps.traverse(function(o){ if(o.userData && o.userData.bulb){ o.userData.bulb.intensity = isNight? 1.2 : 0; } }); }
  btnMode.addEventListener('click', function(){ isNight=!isNight; applyMode(); popMsg(isNight? 'Night lights on âœ¨':'Daylight feels good'); }); applyMode();

  // ---------- Drag-to-move (no auto unless toggled) ----------
  var enableAuto=false; var autoSpeed = 2.2; // m/s along +z of scene.position
  btnAuto.addEventListener('click', function(){ enableAuto=!enableAuto; btnAuto.textContent = 'Auto: ' + (enableAuto? 'On':'Off'); if(enableAuto) tip('Auto moving â€” you can still drag'); });
  rngSpeed.addEventListener('input', function(){ autoSpeed=parseFloat(rngSpeed.value); });

  var dragActive=false; var lastY=0; var lastX=0; var velZ=0; var velX=0; var friction=0.92; var dragFactor = 0.02; // how much screen px translates to world meters

  renderer.domElement.addEventListener('pointerdown', function(e){ dragActive=true; lastY=e.clientY; lastX=e.clientX; renderer.domElement.setPointerCapture(e.pointerId); if(!audioCtx){ initAudio(); } });
  renderer.domElement.addEventListener('pointermove', function(e){ if(!dragActive) return; var dy=e.clientY-lastY; var dx=e.clientX-lastX; lastY=e.clientY; lastX=e.clientX; // drag up moves forward (negative dy)
    velZ += (-dy)*dragFactor; // accumulate velocity
    velX += (-dx)*dragFactor*0.06; // gentle side sway
  });
  renderer.domElement.addEventListener('pointerup', function(e){ dragActive=false; renderer.domElement.releasePointerCapture(e.pointerId); });
  renderer.domElement.addEventListener('pointercancel', function(){ dragActive=false; });

  // ---------- HUD Panel toggle & controls ----------
  btnHUD.addEventListener('click', function(){ panel.style.display = panel.style.display==='none' || panel.style.display==='' ? 'block' : 'none'; });
  btnReset.addEventListener('click', function(){ camera.position.set(0,2.2,6); controls.target.set(0,1.2,-5); controls.update(); tip('View reset'); });
  rngGrass.addEventListener('change', function(){ var val=parseInt(rngGrass.value,10); resetGrass(val); tip('Grass respawned'); });

  function resetGrass(count){
    bladeCount = count; scene.remove(grass); grass.geometry.dispose(); grass.material.dispose();
    grass = new THREE.InstancedMesh(bladeGeo, grassMat, bladeCount); scene.add(grass); scatterGrass();
  }

  // ---------- Animation Loop ----------
  var last=performance.now(), acc=0, frames=0;
  function animate(now){
    var dt=Math.min(0.033, (now-last)/1000); last=now; var t=now/1000;

    // Auto movement adds velocity; otherwise only drag controls it
    if(enableAuto){ velZ += autoSpeed*dt; }

    // Apply velocities with friction
    scene.position.z += velZ*dt; velZ *= friction;
    scene.position.x += velX*dt; velX *= friction;

    // keep path edges aligned
    accents.position.z = scene.position.z;
    chipPos.textContent = 'z: ' + (-(scene.position.z)).toFixed(1);

    // camera eye wobble for life
    camera.position.y = 2.1 + Math.sin(now*0.001)*0.06;

    controls.update(); // desktop viewing

    ensure(camera.position.z - scene.position.z); // spawn ahead

    // Grass wind
    grassMat.uniforms.uTime.value += dt;

    // Animate scene actors
    scene.traverse(function(o){
      if(o.userData){
        if(o.userData.wings && o.userData.type==='bird'){ animBird(o, t + (o.userData.seed||0)); }
        if(o.userData.type==='butterfly'){ animButterfly(o, t + (o.userData.seed||0)); }
        if(o.userData.lid){ // gifts
          var lid=o.userData.lid; var target= lid.userData.open ? Math.PI*0.8 : 0; lid.rotation.x += (target - lid.rotation.x)*0.12;
          if(o.userData.glow){ var want=(isNight && lid.userData.open)?2.0:(isNight?0.6:0.0); o.userData.glow.intensity += (want - o.userData.glow.intensity)*0.1; o.userData.glow.position.copy(o.getWorldPosition(new THREE.Vector3())).add(new THREE.Vector3(0,0.5,0)); }
        }
        if(o.userData.glow && (o.userData.type==='flower' || o.userData.type==='candy')){
          var want2=isNight?1.0:0.0; o.userData.glow.intensity += (want2 - o.userData.glow.intensity)*0.08; o.userData.glow.position.copy(o.getWorldPosition(new THREE.Vector3())).add(new THREE.Vector3(0,0.38,0));
        }
        if(o.userData._pulse){ var age=(now-o.userData._pulse)/400; if(age<1){ var s=1+Math.sin(age*Math.PI)*0.25; o.scale.set(s,s,s); } else { o.scale.set(1,1,1); o.userData._pulse=0; } }
        if(o.userData._bounce){ var age2=(now-o.userData._bounce)/600; if(age2<1){ var off=Math.sin(age2*Math.PI)*0.15; o.position.y=(o.userData._baseY||0)+off; } else { o.position.y=(o.userData._baseY||0); o.userData._bounce=0; } }
      }
    });

    // Occasional bird chirps when moving (requires sound on)
    if(audioCtx && soundOn && (enableAuto || Math.abs(velZ)>0.2)){
      if(now - lastChirp > 1200 + Math.random()*1800){ chirp(); lastChirp=now; }
    }

    updateConfetti(dt); updateFireflies(t); updateStars(dt);
    renderer.render(scene,camera);

    // FPS counter
    acc+=dt; frames++; if(acc>0.5){ chipFPS.textContent='FPS: '+Math.round(frames/acc); acc=0; frames=0; }

    requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);

  // ---------- Resize ----------
  window.addEventListener('resize', function(){ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

  // ---------- Initial Tip ----------
  setTimeout(function(){ tip('Tip: Drag up/down to move â€¢ Tap gifts/flowers/candies â€¢ Tap hoardings for photos'); }, 900);

  // ========= Helper: initial chunk seeding =========
  ensure( camera.position.z - scene.position.z );

  // ========== Extra: keyboard helpers (optional) ==========
  window.addEventListener('keydown', function(e){
    if(e.key==='n'){ isNight=!isNight; applyMode(); }
    if(e.key==='c'){ confettiBurst(new THREE.Vector3(0,1, camera.position.z - scene.position.z - 2)); }
    if(e.key==='h'){ panel.style.display = panel.style.display==='none'||panel.style.display===''? 'block':'none'; }
  });

  </script>
</body>
</html>
