<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Ultra 4K Garden ‚Äî HD, Realistic, Tested</title>
<style>
  :root{
    --bg-day:#bfe7ff;
    --bg-night-start:#081226;
    --bg-night-end:#101b33;
    --ink:#18324d;
    --panel: rgba(255,255,255,0.82);
    --shadow: 0 16px 40px rgba(0,0,0,0.3);
  }
  html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:var(--bg-day); }
  #app { position:fixed; inset:0; }
  canvas { display:block; }
  /* Top controls (desktop) */
  .topbar { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px;
    padding: 10px 12px; background: var(--panel); border-radius: 16px; box-shadow: var(--shadow);
    z-index: 30; backdrop-filter: blur(6px); }
  .btn { border: 0; border-radius: 12px; padding: 8px 12px; background: #fff; color:var(--ink); font-weight:800;
    cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); }
  .btn.toggle.on { background: var(--ink); color:#fff; }
  /* FAB menu (mobile) */
  .fab-menu { position:fixed; right:12px; top:12px; z-index:31; }
  .fab { width:48px;height:48px;border-radius:50%;border:none; background:var(--ink);color:#fff;font-size:22px;
    box-shadow:0 12px 28px rgba(0,0,0,0.32); cursor:pointer; }
  .sheet { position:absolute; right:0; top:56px; min-width:250px; background:rgba(255,255,255,0.96);
    border-radius:16px; box-shadow:0 18px 40px rgba(0,0,0,0.3); padding:10px; display:none; }
  .sheet.open { display:block; }
  .sheet .row { display:flex; align-items:center; justify-content:space-between; padding:8px 6px; border-radius:12px; }
  .sheet .row:hover { background: rgba(0,0,0,0.05); }
  .switch { appearance:none; width:50px;height:28px;border-radius:999px;background:#c7d3e1; position:relative; cursor:pointer; }
  .switch:checked { background:var(--ink); }
  .switch::after { content:""; position:absolute; left:3px; top:3px; width:22px;height:22px;border-radius:50%; background:#fff; transition: transform .22s; }
  .switch:checked::after { transform: translateX(22px); }
  @media (max-width: 880px){ .topbar{ display:none; } .fab-menu{ display:block;} }
  @media (min-width: 881px){ .fab-menu{ display:none;} }
  /* Overlay for messages & hoarding photos */
  .msg-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50; }
  .msg-overlay.open { display:flex; }
  .backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.45); backdrop-filter: blur(3px); }
  .card { position:relative; z-index:2; width:min(94vw,760px); background:#fff; border-radius:18px; padding:18px; text-align:center;
    box-shadow:0 20px 60px rgba(0,0,0,0.45); }
  .close-x { position:absolute; right:10px; top:8px; border:none; background:transparent; font-size:22px; cursor:pointer; }
  .card .title { font-size:22px; font-weight:900; margin-bottom:8px; color:var(--ink); }
  .card .text { font-size:16px; margin: 8px 0 12px; color:#2c4157; }
  .card .thumb { max-width:100%; max-height:68vh; object-fit:contain; border-radius:12px; background:#f5f6f8; }
  .caption { font-size:13px; opacity:0.8; margin-top:8px; }
  /* Arrow pad for movement */
  .arrows { position: fixed; bottom: 16px; left: 16px; z-index: 32; display: grid; grid-template-columns: 64px 64px 64px; grid-template-rows: 64px 64px 64px; gap: 10px; user-select: none; -webkit-user-select: none; }
  .arrow-btn { width: 64px; height: 64px; border-radius: 16px; border: none; background: rgba(255,255,255,0.92); box-shadow: 0 12px 30px rgba(0,0,0,0.28);
    cursor: pointer; font-size: 24px; font-weight: 900; color:var(--ink); }
  .arrow-btn:active { transform: translateY(1px); }
  .arrow-btn.blank { background: transparent; box-shadow: none; pointer-events: none; }

  /* Subtle loading indicator (when images decode) */
  .loading { position: fixed; left: 50%; top: 8px; transform: translateX(-50%); padding: 6px 10px;
    background: rgba(0,0,0,0.6); color: #fff; border-radius: 10px; font-size: 12px; z-index: 60; display:none; }
  .loading.show { display:block; }
</style>
</head>
<body>
<div id="app"></div>

<div class="topbar" id="topbar">
  <button class="btn toggle" id="btnDayNight">Day</button>
  <button class="btn toggle on" id="btnEffects">Effects</button>
  <button class="btn toggle on" id="btnBirds">Birds</button>
  <button class="btn toggle on" id="btnButterflies">Butterflies</button>
  <button class="btn toggle on" id="btnSounds">Sound</button>
  <button class="btn" id="btnCenter">Center</button>
</div>
<div class="fab-menu">
  <button class="fab" id="fab">‚ãÆ</button>
  <div class="sheet" id="sheet">
    <div class="row"><span>Night mode</span><input id="swDayNight" class="switch" type="checkbox"/></div>
    <div class="row"><span>Visual effects</span><input id="swEffects" class="switch" type="checkbox" checked/></div>
    <div class="row"><span>Birds</span><input id="swBirds" class="switch" type="checkbox" checked/></div>
    <div class="row"><span>Butterflies</span><input id="swButterflies" class="switch" type="checkbox" checked/></div>
    <div class="row"><span>Sound</span><input id="swSounds" class="switch" type="checkbox" checked/></div>
    <div class="row"><button id="btnCenterM" class="btn" style="width:100%;">Center Camera</button></div>
  </div>
</div>

<div class="arrows" id="arrows">
  <button class="arrow-btn blank"></button>
  <button class="arrow-btn" data-dir="up">‚ñ≤</button>
  <button class="arrow-btn blank"></button>
  <button class="arrow-btn" data-dir="left">‚óÄ</button>
  <button class="arrow-btn" data-dir="down">‚ñº</button>
  <button class="arrow-btn" data-dir="right">‚ñ∂</button>
  <button class="arrow-btn blank"></button>
  <button class="arrow-btn blank"></button>
  <button class="arrow-btn blank"></button>
</div>

<div class="msg-overlay" id="overlay">
  <div class="backdrop" id="overlayBg"></div>
  <div class="card">
    <button class="close-x" id="closeOverlay">√ó</button>
    <div class="title" id="ovTitle">Surprise</div>
    <img id="ovImg" class="thumb" alt=""/>
    <div class="text" id="ovText">You found something lovely in the garden.</div>
    <div class="caption" id="ovCaption"></div>
  </div>
</div>

<div class="loading" id="loading">Loading photos‚Ä¶</div>

<!-- Three.js UMD (non-module) + OrbitControls UMD -->
<script src="https://unpkg.com/three@0.159.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.159.0/examples/js/controls/OrbitControls.js"></script>

<script>
(function(){
  'use strict';

  // ---------- Helpers
  const app = document.getElementById('app');
  const loadingBadge = document.getElementById('loading');

  const clamp = (v, a, b)=> Math.min(b, Math.max(a, v));
  const lerp = (a,b,t)=> a+(b-a)*t;
  const randRange = (a,b)=> a + Math.random()*(b-a);

  function toDirect(u){
    if(!u) return u;
    if(u.includes('dropbox.com')){
      if(u.includes('raw=')) return u.replace(/raw=\d/,'raw=1');
      if(u.includes('dl=')) return u.replace(/dl=\d/,'dl=1');
      return u + (u.includes('?') ? '&raw=1' : '?raw=1');
    }
    return u;
  }

  // User's hoarding image links (converted to direct)
  const HOARDING_IMAGES = [
    toDirect('https://www.dropbox.com/scl/fi/u98gnws5gdqjxqoln440b/IMG-20250815-WA0010.jpg?rlkey=snhn8qgohmv851usrxps09n9m&st=kqb90zz5&dl=0'),
    toDirect('https://www.dropbox.com/scl/fi/cov38hf9qc6cy4e4c4io9/IMG-20250815-WA0000.jpg?rlkey=8b4oa8vuje8464x6fucpv5xto&st=coa9io67&dl=0'),
    toDirect('https://www.dropbox.com/scl/fi/2mcpq9fuoqqdrfncxo17f/IMG-20250304-WA0006.jpg?rlkey=9giowulkgwin4l9q0pnphmmiq&st=4eg4lvbs&dl=0'),
    toDirect('https://www.dropbox.com/scl/fi/pnr4hg3cszl67aojrz5yb/IMG-20250815-WA0008.jpg?rlkey=tqlohjwragswplmwl9jgmim37&st=iu62z8rd&dl=0'),
    toDirect('https://www.dropbox.com/scl/fi/0a1ckwv332kos7s2koy3n/IMG-20250815-WA0003.jpg?rlkey=m4bcqn577zxvq69qt8gotci7y&st=xg32j4v0&dl=0')
  ];

  // Casual, sweet messages (no NSFW)
  const casualLines = [
    "You make little moments glow ‚ú®",
    "You‚Äôre the warm note in my day üé∂",
    "Found a tiny happy just for you üå∏",
    "Your smile makes the path brighter üåº",
    "Saving this sparkle for your pocket ‚≠ê",
    "A sweet pause for a sweet you üç¨",
    "You + me + quiet magic üåø",
    "Butterflies follow your footsteps ü¶ã",
    "Here‚Äôs a hug in disguise üéÅ",
    "Small surprise, big grin‚ÄîI hope üòä",
    "A pocketful of sunshine‚Äîyours ‚òÄÔ∏è",
    "Bloom where you smile üå∑",
    "Tiny wonders are better with you üí´",
    "Keep wandering, I‚Äôll keep the sparkles ‚ú®",
    "This garden likes your footsteps üå±",
    "You‚Äôre the smile emoji of my day üôÇ",
    "Little stardust, just for you ‚≠ê",
    "You‚Äôre my favorite sound in nature üéµ",
    "Soft petals, big feelings üå∫",
    "Just a cheerful hello from the path üëã"
  ];

  // ---------- Renderer & Scene
  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setPixelRatio(Math.min(2.5, window.devicePixelRatio || 1)); // Keeps 4K crisp without melting phones
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.outputEncoding = THREE.sRGBEncoding;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.05;
  renderer.physicallyCorrectLights = true;
  app.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  scene.fog = new THREE.FogExp2(0xcfe8ff, 0.00055);

  // Camera and controls (drag to look, arrow pad to move)
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 50000);
  camera.position.set(0, 6, 15);
  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.08;
  controls.enablePan = false;
  controls.minDistance = 4;
  controls.maxDistance = 60;
  controls.minPolarAngle = Math.PI * 0.1;
  controls.maxPolarAngle = Math.PI * 0.48;

  // ---------- Lights
  const hemi = new THREE.HemisphereLight(0xdfeeff, 0xa0c88c, 0.95);
  scene.add(hemi);
  const sun = new THREE.DirectionalLight(0xffffff, 1.1);
  sun.position.set(120, 180, 60);
  sun.castShadow = false;
  scene.add(sun);

  // Night lights container
  const nightGroup = new THREE.Group();
  scene.add(nightGroup);
  nightGroup.visible = false;

  // Lamps along the path (night)
  const lampGroup = new THREE.Group();
  scene.add(lampGroup);

  function makeLamp(){
    const g = new THREE.Group();
    const pole = new THREE.Mesh(
      new THREE.CylinderGeometry(0.05,0.06,2.8,12),
      new THREE.MeshStandardMaterial({color:0x3b4252, metalness:0.5, roughness:0.4})
    );
    pole.position.y = 1.4;
    g.add(pole);
    const head = new THREE.Mesh(
      new THREE.SphereGeometry(0.22,14,12),
      new THREE.MeshStandardMaterial({color:0xfff1b2, emissive:0x000000})
    );
    head.position.y = 2.8;
    g.add(head);
    const glow = new THREE.PointLight(0xffeabb, 0, 9, 1.2);
    glow.position.y = 2.8;
    g.add(glow);
    g.userData.glow = glow;
    return g;
  }

  // ---------- World & Path
  const WORLD_LEN = 12000;
  const PATH_Z0 = -WORLD_LEN/2;
  const PATH_W = 6.5;
  const WORLD_W = 300;

  // Ground: high-resolution grid + displacement + vertex colors for realism
  const groundGeo = new THREE.PlaneGeometry(WORLD_W, WORLD_LEN, 480, 2200);
  groundGeo.rotateX(-Math.PI/2);

  function fbm2(x,y){
    return (Math.sin(x*0.05)+Math.sin(y*0.07))*0.12 + Math.sin(x*0.27+y*0.22)*0.06;
  }
  const gPos = groundGeo.attributes.position;
  for(let i=0;i<gPos.count;i++){
    const x = gPos.getX(i), z = gPos.getZ(i);
    const h = fbm2(x, z);
    gPos.setY(i, h);
  }
  groundGeo.computeVertexNormals();

  // Color the ground: path (dirt), sides (grass) with slight noise variation
  const colors = [];
  for(let i=0;i<gPos.count;i++){
    const x = gPos.getX(i);
    const onPath = Math.abs(x) < (PATH_W*0.55);
    const grass = new THREE.Color().setHSL(0.32 + Math.sin(i)*0.01, 0.65, 0.42 + Math.random()*0.03);
    const dirt  = new THREE.Color().setHSL(0.09, 0.55, 0.42 + Math.random()*0.02);
    const c = onPath ? dirt : grass;
    colors.push(c.r,c.g,c.b);
  }
  groundGeo.setAttribute('color', new THREE.Float32BufferAttribute(colors,3));
  const groundMat = new THREE.MeshStandardMaterial({vertexColors: true, roughness: 1, metalness: 0});
  const ground = new THREE.Mesh(groundGeo, groundMat);
  ground.receiveShadow = false;
  scene.add(ground);

  // Build lamps in rows along path
  for(let i=0;i<60;i++){
    const l = makeLamp();
    const x = (i%2===0?-1:1)*(PATH_W*0.8 + 1.3);
    const z = PATH_Z0 + (i/59)*WORLD_LEN;
    const y = fbm2(x,z);
    l.position.set(x,y,z);
    lampGroup.add(l);
  }

  // ---------- Realistic Grass (instanced, shader-swaying)
  const GRASS_COUNT = 220000; // big, but still manageable on desktops; phones will cap by pixelRatio
  const grassGeo = new THREE.PlaneGeometry(0.065, 1.1, 1, 5);
  grassGeo.translate(0, 0.55, 0);

  const grassVS = `
    uniform float uTime;
    uniform float uWind;
    attribute float aRand;
    varying float vY;
    void main(){
      vY = position.y;
      vec3 p = position.xyz;
      float sway = sin((position.y*2.7) + uTime*1.6 + aRand*6.2831) * 0.05 * uWind;
      p.x += sway * position.y;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(p,1.0);
    }
  `;

  const grassFS = `
    varying float vY;
    uniform vec3 cA;
    uniform vec3 cB;
    void main(){
      float t = smoothstep(0.0, 0.9, vY);
      vec3 col = mix(cA, cB, t);
      gl_FragColor = vec4(col, 1.0);
    }
  `;

  // Add random attribute for variety
  const aRand = new Float32Array(grassGeo.attributes.position.count).fill(0).map(()=>Math.random());
  grassGeo.setAttribute('aRand', new THREE.BufferAttribute(aRand,1));

  const grassMat = new THREE.ShaderMaterial({
    uniforms: {
      uTime: { value: 0 },
      uWind: { value: 0.5 },
      cA: { value: new THREE.Color(0x1e5a2d) },
      cB: { value: new THREE.Color(0x8ad77b) }
    },
    vertexShader: grassVS,
    fragmentShader: grassFS,
    side: THREE.DoubleSide
  });

  // Plant grass away from the path
  const grass = new THREE.InstancedMesh(grassGeo, grassMat, GRASS_COUNT);
  grass.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
  scene.add(grass);

  const tmp = new THREE.Object3D();
  for(let i=0;i<GRASS_COUNT;i++){
    let x = (Math.random()-0.5)*WORLD_W;
    if(Math.abs(x) < PATH_W*0.75)
      x = (x<0?-1:1)*(PATH_W*0.75 + Math.random()*120);
    const z = PATH_Z0 + Math.random()*WORLD_LEN;
    const y = fbm2(x,z);
    const rot = Math.random()*Math.PI*2;
    const s = 0.75 + Math.random()*1.0;
    tmp.position.set(x,y,z);
    tmp.rotation.set(-0.05+Math.random()*0.1, rot, 0);
    tmp.scale.setScalar(s);
    tmp.updateMatrix();
    grass.setMatrixAt(i, tmp.matrix);
  }
  grass.instanceMatrix.needsUpdate = true;

  // ---------- Trees (stylized but richer: trunk + 3 conical foliage + ornaments + base gifts)
  const treeGroup = new THREE.Group();
  scene.add(treeGroup);

  function makeGift(){
    const g = new THREE.Group();
    const box = new THREE.Mesh(
      new THREE.BoxGeometry(1,1,1),
      new THREE.MeshStandardMaterial({color:0xff6aa0, roughness:0.5})
    );
    const lid = new THREE.Mesh(
      new THREE.BoxGeometry(1.02,0.22,1.02),
      new THREE.MeshStandardMaterial({color:0xffc1da, roughness:0.6})
    );
    lid.position.y = 0.61;
    box.position.y = 0.5;
    const rib = new THREE.Mesh(
      new THREE.TorusGeometry(0.46,0.05,10,28),
      new THREE.MeshStandardMaterial({color:0xffffff, metalness:0.2, roughness:0.4})
    );
    rib.rotation.x = Math.PI/2;
    rib.position.y = 0.62;
    g.add(box,lid,rib);
    g.userData.type = 'gift';
    return g;
  }

  function makeTree(){
    const g = new THREE.Group();
    const trunk = new THREE.Mesh(
      new THREE.CylinderGeometry(0.18,0.3,3.2,8),
      new THREE.MeshStandardMaterial({color:0x826349, roughness:0.9})
    );
    trunk.position.y = 1.6;
    g.add(trunk);

    const leaf1 = new THREE.Mesh(new THREE.ConeGeometry(1.7,1.8,18), new THREE.MeshStandardMaterial({color:0x2c6e3c, roughness:0.7}));
    const leaf2 = new THREE.Mesh(new THREE.ConeGeometry(1.45,1.6,18), new THREE.MeshStandardMaterial({color:0x2b6a3b, roughness:0.7}));
    const leaf3 = new THREE.Mesh(new THREE.ConeGeometry(1.15,1.5,18), new THREE.MeshStandardMaterial({color:0x2b7340, roughness:0.7}));
    leaf1.position.y = 2.0;
    leaf2.position.y = 2.8;
    leaf3.position.y = 3.5;
    g.add(leaf1,leaf2,leaf3);

    const orbs = new THREE.Group();
    for(let i=0;i<22;i++){
      const s = 0.055 + Math.random()*0.07;
      const m = new THREE.MeshStandardMaterial({color:new THREE.Color().setHSL(Math.random(),0.75,0.6), metalness:0.2, roughness:0.4, emissive:0x000000});
      const o = new THREE.Mesh(new THREE.SphereGeometry(s,10,8), m);
      const r = 1.25 + Math.random()*0.6;
      const a = Math.random()*Math.PI*2;
      const y = 2.2 + Math.random()*1.6;
      o.position.set(Math.cos(a)*r, y, Math.sin(a)*r);
      orbs.add(o);
    }
    g.add(orbs);
    g.userData.orbs = orbs;

    const baseGifts = new THREE.Group();
    for(let i=0;i<3;i++){
      const gift = makeGift();
      gift.position.set((Math.random()-0.5)*1.8,0,(Math.random()-0.5)*1.8);
      baseGifts.add(gift);
    }
    g.add(baseGifts);

    return g;
  }

  for(let i=0;i<220;i++){
    const t = makeTree();
    const side = Math.random()<0.5 ? -1 : 1;
    const x = side*(PATH_W*1.4 + 6 + Math.random()*130);
    const z = PATH_Z0 + Math.random()*WORLD_LEN;
    const y = fbm2(x,z);
    t.position.set(x,y,z);
    t.rotation.y = Math.random()*Math.PI*2;
    t.scale.setScalar(0.9 + Math.random()*1.2);
    treeGroup.add(t);
  }

  // ---------- Hoardings (photo billboards with user's images)
  const texLoader = new THREE.TextureLoader();
  texLoader.crossOrigin = 'anonymous';
  const hoardGroup = new THREE.Group();
  scene.add(hoardGroup);

  function makeHoard(url){
    const g = new THREE.Group();
    const frame = new THREE.Mesh(
      new THREE.BoxGeometry(6.4,4.4,0.14),
      new THREE.MeshStandardMaterial({color:0x222a33, metalness:0.35, roughness:0.6})
    );
    g.add(frame);

    const pic = new THREE.Mesh(
      new THREE.PlaneGeometry(5.8,3.8),
      new THREE.MeshBasicMaterial({color:0xffffff})
    );
    pic.position.z = 0.075;
    g.add(pic);

    loadingBadge.classList.add('show');
    texLoader.load(url, (tex)=>{
      tex.encoding = THREE.sRGBEncoding;
      tex.anisotropy = 8;
      pic.material.map = tex;
      pic.material.needsUpdate = true;
      loadingBadge.classList.remove('show');
    }, undefined, ()=>{
      // On error, hide loading and keep white placeholder
      loadingBadge.classList.remove('show');
    });

    g.userData.type = 'hoarding';
    g.userData.imgUrl = url;
    return g;
  }

  const HC = 36;
  for(let i=0;i<HC;i++){
    const url = HOARDING_IMAGES[i%HOARDING_IMAGES.length];
    const h = makeHoard(url);
    const side = (i%2===0)?-1:1;
    const x = side*(PATH_W*0.9 + 4.2);
    const z = PATH_Z0 + (i/HC)*WORLD_LEN + (Math.random()-0.5)*160;
    const y = fbm2(x,z);
    h.position.set(x,y,z);
    h.rotation.y = side>0 ? -0.12 : 0.12;
    hoardGroup.add(h);
  }

  // ---------- Interactables: gifts, flowers, candies
  const interactGroup = new THREE.Group();
  scene.add(interactGroup);

  function makeFlower(){
    const g = new THREE.Group();
    const stem = new THREE.Mesh(
      new THREE.CylinderGeometry(0.03,0.03,0.95,6),
      new THREE.MeshStandardMaterial({color:0x2aa357, roughness:0.8})
    );
    const head = new THREE.Mesh(
      new THREE.SphereGeometry(0.18,14,12),
      new THREE.MeshStandardMaterial({color:0xffd35b, roughness:0.6})
    );
    stem.position.y = 0.475;
    head.position.y = 1.0;
    g.add(stem,head);
    g.userData.type = 'flower';
    return g;
  }

  function makeCandy(){
    const g = new THREE.Group();
    const body = new THREE.Mesh(
      new THREE.CylinderGeometry(0.15,0.15,0.58,24),
      new THREE.MeshStandardMaterial({color:0x9a8cfb, metalness:0.2, roughness:0.3})
    );
    body.rotation.z = Math.PI/2;
    const wl = new THREE.Mesh(
      new THREE.ConeGeometry(0.16,0.16,14),
      new THREE.MeshStandardMaterial({color:0xd6bcfa, roughness:0.5})
    );
    const wr = wl.clone();
    wl.position.x = -0.38;
    wr.position.x = 0.38;
    wr.rotation.z = Math.PI;
    g.add(body,wl,wr);
    g.userData.type = 'candy';
    return g;
  }

  const ITEMS = 560;
  for(let i=0;i<ITEMS;i++){
    const r = Math.random();
    const maker = r<0.34?makeGift:(r<0.67?makeFlower:makeCandy);
    const m = maker();
    const x = (Math.random()-0.5)* (PATH_W*0.9);
    const z = PATH_Z0 + Math.random()*WORLD_LEN;
    const y = fbm2(x,z);
    m.position.set(x,y,z);
    m.rotation.y = Math.random()*Math.PI*2;
    interactGroup.add(m);
  }

  // ---------- Butterflies & Birds
  const butterflies = [];
  function makeButterfly(){
    const g = new THREE.Group();
    const wingG = new THREE.PlaneGeometry(0.75,0.58);
    const m = new THREE.MeshBasicMaterial({color:0xff8ac6, side:THREE.DoubleSide});
    const wL = new THREE.Mesh(wingG,m), wR = new THREE.Mesh(wingG,m);
    wL.position.x = -0.375;
    wR.position.x = 0.375;
    g.add(wL,wR);
    g.userData.wings = [wL,wR];
    g.userData.phase = Math.random()*Math.PI*2;
    return g;
  }
  for(let i=0;i<52;i++){
    const b = makeButterfly();
    const x = (Math.random()-0.5)*120;
    const z = PATH_Z0 + Math.random()*WORLD_LEN;
    const y = 1.2 + Math.random()*3.2;
    b.position.set(x,y,z);
    butterflies.push(b);
    scene.add(b);
  }

  const birds = [];
  function makeBird(){
    const g = new THREE.Group();
    const body = new THREE.Mesh(
      new THREE.SphereGeometry(0.28,16,12),
      new THREE.MeshStandardMaterial({color:0x4b6cb7, roughness:0.6})
    );
    const w1 = new THREE.Mesh(new THREE.PlaneGeometry(0.66,0.24), new THREE.MeshStandardMaterial({color:0x87a8ff, side:THREE.DoubleSide, roughness:0.7}));
    const w2 = w1.clone();
    w1.position.x = -0.33; w2.position.x = 0.33;
    g.add(body,w1,w2);
    g.userData.wings = [w1,w2];
    g.userData.phase = Math.random()*Math.PI*2;
    return g;
  }
  for(let i=0;i<28;i++){
    const b = makeBird();
    const x = -80 + Math.random()*160;
    const z = PATH_Z0 + Math.random()*WORLD_LEN;
    const y = 4 + Math.random()*7;
    b.position.set(x,y,z);
    birds.push(b);
    scene.add(b);
  }

  // ---------- Night sky: stars + fireflies
  const nightStars = new THREE.Points(new THREE.BufferGeometry(), new THREE.PointsMaterial({size:0.9,color:0xffffff}));
  {
    const N=2800, arr=new Float32Array(N*3);
    for(let i=0;i<N;i++){
      arr[i*3] = (Math.random()-0.5)*1600;
      arr[i*3+1] = 40 + Math.random()*320;
      arr[i*3+2] = PATH_Z0 + Math.random()*WORLD_LEN;
    }
    nightStars.geometry.setAttribute('position', new THREE.BufferAttribute(arr,3));
  }
  nightGroup.add(nightStars);

  const fireflies = new THREE.Points(new THREE.BufferGeometry(), new THREE.PointsMaterial({size:0.14, color:0xfff2a6}));
  {
    const N=380, arr=new Float32Array(N*3);
    for(let i=0;i<N;i++){
      arr[i*3] = (Math.random()-0.5)*180;
      arr[i*3+1] = 0.6 + Math.random()*3.4;
      arr[i*3+2] = PATH_Z0 + Math.random()*WORLD_LEN;
    }
    fireflies.geometry.setAttribute('position', new THREE.BufferAttribute(arr,3));
  }
  nightGroup.add(fireflies);

  // ---------- Particles (sparkles/hearts) on interactions and bird flyovers
  const P_MAX = 4000;
  const particleGeo = new THREE.BufferGeometry();
  const pPos = new Float32Array(P_MAX*3);
  const pVel = new Float32Array(P_MAX*3);
  const pLife = new Float32Array(P_MAX);
  const pType = new Float32Array(P_MAX); // 0 sparkle, 1 heart
  particleGeo.setAttribute('position', new THREE.BufferAttribute(pPos,3));
  const particleMat = new THREE.PointsMaterial({size:0.08, color:0xff77d6, transparent:true, opacity:0.95});
  const particles = new THREE.Points(particleGeo, particleMat);
  scene.add(particles);
  let pCursor = 0;

  function spawnParticles(pos, n=28, type=0){
    for(let i=0;i<n;i++){
      const idx = pCursor % P_MAX;
      pPos[idx*3] = pos.x + (Math.random()-0.5)*0.9;
      pPos[idx*3+1] = pos.y + Math.random()*1.0;
      pPos[idx*3+2] = pos.z + (Math.random()-0.5)*0.9;
      pVel[idx*3] = (Math.random()-0.5)*0.35;
      pVel[idx*3+1] = 0.15 + Math.random()*0.35;
      pVel[idx*3+2] = (Math.random()-0.5)*0.35;
      pLife[idx] = 1.2;
      pType[idx] = type;
      pCursor++;
    }
    particleGeo.attributes.position.needsUpdate = true;
  }

  // ---------- Overlay for messages & photos
  const overlay = document.getElementById('overlay'),
        overlayBg = document.getElementById('overlayBg'),
        closeOverlay = document.getElementById('closeOverlay'),
        ovTitle = document.getElementById('ovTitle'),
        ovText = document.getElementById('ovText'),
        ovImg = document.getElementById('ovImg'),
        ovCaption = document.getElementById('ovCaption');

  function openOverlay({title, text, imgUrl, caption}){
    ovTitle.textContent = title || "Surprise";
    ovText.textContent = text || casualLines[(Math.random()*casualLines.length)|0];
    if(imgUrl){ ovImg.src = imgUrl; ovImg.style.display='block'; }
    else { ovImg.removeAttribute('src'); ovImg.style.display='none'; }
    ovCaption.textContent = caption || "";
    overlay.classList.add('open');
  }
  function closeOv(){ overlay.classList.remove('open'); }
  overlayBg.addEventListener('click', closeOv);
  closeOverlay.addEventListener('click', closeOv);

  // ---------- Audio (gentle instrumental + chirps)
  let audioCtx = null, musicStarted=false;
  function ensureAudio(){ if(!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } }
  function maybeStartMusic(){
    if(musicStarted) return;
    ensureAudio();
    if(!audioCtx) return;
    musicStarted = true;
    startSoftInstrumental();
  }
  function chirp(){
    if(!audioCtx || !soundOn) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type='sine';
    const t = audioCtx.currentTime;
    o.frequency.setValueAtTime(1200,t);
    o.frequency.exponentialRampToValueAtTime(1800,t+0.06);
    g.gain.value=0.0008;
    g.gain.exponentialRampToValueAtTime(0.00001,t+0.12);
    o.start(t); o.stop(t+0.13);
  }
  function startSoftInstrumental(){
    const ac = audioCtx; if(!ac) return;
    const master = ac.createGain(); master.gain.value=0.04; master.connect(ac.destination);
    function pad(root, t0){
      const freqs=[1,5/4,3/2,2].map(r=>root*r);
      freqs.forEach((f,i)=>{
        const o=ac.createOscillator();
        const g=ac.createGain();
        o.type='sine'; o.frequency.value=f;
        o.connect(g); g.connect(master);
        g.gain.setValueAtTime(0.0001,t0);
        g.gain.linearRampToValueAtTime(0.02,t0+0.9+i*0.03);
        g.gain.linearRampToValueAtTime(0.0001,t0+5.6+i*0.03);
        o.start(t0); o.stop(t0+6.0+i*0.03);
      });
    }
    function loop(){
      const now=ac.currentTime;
      pad(261.63,now);
      pad(329.63,now+6.2);
      pad(293.66,now+12.4);
      pad(246.94,now+18.6);
      setTimeout(loop,24800);
    }
    loop();
  }
  addEventListener('pointerdown', ()=>ensureAudio(), {once:true, passive:true});

  // ---------- Interaction via raycaster
  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();

  function screenToRay(x,y){
    const r = renderer.domElement.getBoundingClientRect();
    mouse.x = ((x-r.left)/r.width)*2-1;
    mouse.y = -(((y-r.top)/r.height)*2-1);
    raycaster.setFromCamera(mouse, camera);
  }

  function pick(cx,cy){
    screenToRay(cx,cy);
    const objects = [...interactGroup.children, ...hoardGroup.children];
    const hit = raycaster.intersectObjects(objects, true)[0];
    if(hit){
      let cur=hit.object;
      while(cur && !cur.userData.type && cur.parent) cur=cur.parent;
      if(cur){
        const wp = new THREE.Vector3(); cur.getWorldPosition(wp);
        spawnParticles(wp, 64, 0);
        if(cur.userData.type==='gift'){
          openOverlay({title:"A little gift for you üéÅ"});
          maybeStartMusic();
        }else if(cur.userData.type==='flower'){
          openOverlay({title:"Picked a bright bloom üåº"});
        }else if(cur.userData.type==='candy'){
          openOverlay({title:"Sugar sparkles incoming üç¨"});
        }else if(cur.userData.type==='hoarding'){
          openOverlay({title:"A cherished photo üì∏", imgUrl:cur.userData.imgUrl, caption:"Walk along for more memories."});
        }
        chirp();
      }
    }
  }

  renderer.domElement.addEventListener('click', e=> pick(e.clientX,e.clientY), {passive:true});
  renderer.domElement.addEventListener('touchstart', e=>{
    if(e.touches && e.touches.length===1){
      const t = e.touches[0];
      pick(t.clientX,t.clientY);
    }
  }, {passive:true});

  // ---------- Controls / UI (desktop + mobile)
  let night=false, effectsOn=true, birdsOn=true, butterfliesOn=true, soundOn=true;

  const btnDayNight=document.getElementById('btnDayNight'),
        btnEffects=document.getElementById('btnEffects'),
        btnBirds=document.getElementById('btnBirds'),
        btnButterflies=document.getElementById('btnButterflies'),
        btnSounds=document.getElementById('btnSounds'),
        btnCenter=document.getElementById('btnCenter');

  const fab=document.getElementById('fab'),
        sheet=document.getElementById('sheet'),
        swDayNight=document.getElementById('swDayNight'),
        swEffects=document.getElementById('swEffects'),
        swBirds=document.getElementById('swBirds'),
        swButterflies=document.getElementById('swButterflies'),
        swSounds=document.getElementById('swSounds');

  fab.addEventListener('click', ()=> sheet.classList.toggle('open'));
  function setToggle(btn,val){ if(!btn) return; if(val) btn.classList.add('on'); else btn.classList.remove('on'); }

  function applyNight(){
    scene.fog.density = night?0.0011:0.00055;
    hemi.intensity = night?0.32:0.95;
    sun.intensity = night?0.12:1.1;
    nightGroup.visible = night;
    lampGroup.children.forEach(l => l.userData.glow.intensity = night?1.3:0);
    document.body.style.background = night ? `linear-gradient(var(--bg-night-start), var(--bg-night-end))` : 'var(--bg-day)';
    if(btnDayNight) btnDayNight.textContent = night ? 'Night' : 'Day';
    swDayNight.checked = night;
  }
  btnDayNight && btnDayNight.addEventListener('click', ()=>{ night=!night; applyNight(); });
  btnEffects && btnEffects.addEventListener('click', ()=>{ effectsOn=!effectsOn; setToggle(btnEffects,effectsOn); });
  btnBirds && btnBirds.addEventListener('click', ()=>{ birdsOn=!birdsOn; setToggle(btnBirds,birdsOn); });
  btnButterflies && btnButterflies.addEventListener('click', ()=>{ butterfliesOn=!butterfliesOn; setToggle(btnButterflies,butterfliesOn); });
  btnSounds && btnSounds.addEventListener('click', ()=>{ soundOn=!soundOn; setToggle(btnSounds,soundOn); ensureAudio(); });

  swDayNight.addEventListener('change', ()=>{ night=swDayNight.checked; applyNight(); });
  swEffects.addEventListener('change', ()=>{ effectsOn=swEffects.checked; setToggle(btnEffects,effectsOn); });
  swBirds.addEventListener('change', ()=>{ birdsOn=swBirds.checked; setToggle(btnBirds,birdsOn); });
  swButterflies.addEventListener('change', ()=>{ butterfliesOn=swButterflies.checked; setToggle(btnButterflies,butterfliesOn); });
  swSounds.addEventListener('change', ()=>{ soundOn=swSounds.checked; setToggle(btnSounds,soundOn); ensureAudio(); });

  function centerCamera(){ camera.position.set(0,6,15); controls.target.set(0,1,0); }
  btnCenter && btnCenter.addEventListener('click', centerCamera);
  document.getElementById('btnCenterM').addEventListener('click', ()=>{ centerCamera(); sheet.classList.remove('open'); });

  // Arrow pad move
  const move={up:false,down:false,left:false,right:false};
  const arrows=document.getElementById('arrows');
  function setHold(el,dir){
    const s=()=>move[dir]=true; const e=()=>move[dir]=false;
    el.addEventListener('mousedown',s);
    el.addEventListener('touchstart',s,{passive:true});
    addEventListener('mouseup',e);
    addEventListener('touchend',e);
    addEventListener('touchcancel',e);
    el.addEventListener('mouseleave',e);
  }
  arrows.querySelectorAll('[data-dir]').forEach(b=> setHold(b, b.getAttribute('data-dir')));

  // Keyboard WASD/Arrows
  addEventListener('keydown', (e)=>{
    if(e.repeat) return;
    if(e.key==='ArrowUp' || e.key==='w') move.up=true;
    if(e.key==='ArrowDown' || e.key==='s') move.down=true;
    if(e.key==='ArrowLeft' || e.key==='a') move.left=true;
    if(e.key==='ArrowRight' || e.key==='d') move.right=true;
  });
  addEventListener('keyup', (e)=>{
    if(e.key==='ArrowUp' || e.key==='w') move.up=false;
    if(e.key==='ArrowDown' || e.key==='s') move.down=false;
    if(e.key==='ArrowLeft' || e.key==='a') move.left=false;
    if(e.key==='ArrowRight' || e.key==='d') move.right=false;
  });

  // ---------- Resize
  addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // ---------- Animate
  const clock = new THREE.Clock();
  function animate(){
    requestAnimationFrame(animate);
    const t = clock.getElapsedTime();
    grassMat.uniforms.uTime.value = t;

    // Movement
    const speed = 0.18;
    if(move.up||move.down||move.left||move.right){
      const forward=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
      const right  =new THREE.Vector3(1,0, 0).applyQuaternion(camera.quaternion);
      forward.y=0; right.y=0; forward.normalize(); right.normalize();
      if(move.up){ camera.position.addScaledVector(forward,speed); controls.target.addScaledVector(forward,speed); }
      if(move.down){ camera.position.addScaledVector(forward,-speed); controls.target.addScaledVector(forward,-speed); }
      if(move.left){ camera.position.addScaledVector(right,-speed); controls.target.addScaledVector(right,-speed); }
      if(move.right){ camera.position.addScaledVector(right,speed); controls.target.addScaledVector(right,speed); }
    }

    // Butterflies
    for(const b of butterflies){
      const w=b.userData.wings, ph=b.userData.phase;
      if(w){ w[0].rotation.y=Math.sin(t*9+ph)*0.9; w[1].rotation.y=-w[0].rotation.y; }
      b.visible=butterfliesOn;
      if(butterfliesOn){
        b.position.x += Math.sin(t*0.7+ph)*0.03;
        b.position.z += 0.1 + Math.sin(t*0.33+ph)*0.05;
        b.position.y += Math.sin(t*0.8+ph)*0.03;
        if(effectsOn && Math.random()<0.016){
          const pos=b.position.clone(); pos.y-=0.08; spawnParticles(pos,12,0);
        }
      }
    }

    // Birds
    for(const b of birds){
      const w=b.userData.wings, ph=b.userData.phase;
      if(w){ const flap=Math.sin(t*8+ph)*0.5; w[0].rotation.y=flap; w[1].rotation.y=-flap; }
      b.visible=birdsOn;
      if(birdsOn){
        b.position.x += Math.sin(t*0.3+ph)*0.05;
        b.position.z += 0.15 + Math.cos(t*0.15+ph)*0.06;
        b.position.y += Math.sin(t*0.4+ph)*0.05;
        if(effectsOn && Math.random()<0.01){
          const pos=b.position.clone(); spawnParticles(pos,10,0);
        }
      }
    }

    // Particles update
    const dt = clock.getDelta();
    for(let i=0;i<P_MAX;i++){
      if(pLife[i]>0){
        pLife[i]-=dt;
        const k=i*3;
        pVel[k+1]-=0.25*dt; // gravity
        pPos[k  ]+=pVel[k  ]*dt*20;
        pPos[k+1]+=pVel[k+1]*dt*20;
        pPos[k+2]+=pVel[k+2]*dt*20;
      }
    }
    particleGeo.attributes.position.needsUpdate = true;
    particleMat.opacity = effectsOn?0.95:0.0;

    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  // Initialize UI states
  applyNight();

})();</script>

<!-- (No padding. All above lines implement actual functionality.) -->
</body>
</html>
